<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Serj L aka Loremaster]]></title>
  <link href="http://bloginius.com/atom.xml" rel="self"/>
  <link href="http://bloginius.com/"/>
  <updated>2015-03-05T15:16:35+03:00</updated>
  <id>http://bloginius.com/</id>
  <author>
    <name><![CDATA[Serj L aka Loremaster]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Another Guide to Upgrade to Rails 4.1]]></title>
    <link href="http://bloginius.com/blog/2014/08/01/another-guide-to-upgrade-to-rails-4-dot-1/"/>
    <updated>2014-08-01T16:03:05+04:00</updated>
    <id>http://bloginius.com/blog/2014/08/01/another-guide-to-upgrade-to-rails-4-dot-1</id>
    <content type="html"><![CDATA[<p>Rails 4.1 is pretty nice release, but upgrade to this version may be painful. In this post I&rsquo;ll try to help you.</p>

<p>First of all, you need to install the latest version of Rails.</p>

<figure class='code'><figcaption><span>Gemfile </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;4.1.2&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;sass-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 4.0.3&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>After that read <a href="http://guides.rubyonrails.org/upgrading_ruby_on_rails.html#upgrading-from-rails-4-0-to-rails-4-1">official rails guide to upgrade to rails 4.1</a>, because I don&rsquo;t want to talk about these details. Just don&rsquo;t touch section about Spring, I&rsquo;ll tell what to do with that.</p>

<!-- more -->


<h3>Shoulda-matchers</h3>

<p>If you use <code>shoulda-matchers</code>, then you may see errors in your specs. To make shoulda-matchers work properly you need to install at least this version:</p>

<figure class='code'><figcaption><span>Gemfile </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;shoulda-matchers&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 2.6.1&#39;</span><span class="p">,</span> <span class="nb">require</span><span class="p">:</span> <span class="kp">false</span>
</span></code></pre></td></tr></table></div></figure>


<p>Only this version (and higher) is compatible with Rails 4.1. After running:</p>

<figure class='code'><figcaption><span>Terminal </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>bundle
</span></code></pre></td></tr></table></div></figure>


<p>You also need to replace in spec_helper.rb this line:</p>

<figure class='code'><figcaption><span>spec_helper.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;shoulda/matchers/integrations/rspec&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>By these two:</p>

<figure class='code'><figcaption><span>spec_helper.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s2">&quot;shoulda/matchers&quot;</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;shoulda/matchers/integrations/rspec&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This fix should be enough.</p>

<h3>Bullet</h3>

<p>Bullet also generates some errors. Solution is very easy:</p>

<figure class='code'><figcaption><span>Gemfile </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;bullet&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 4.9.0&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Squel</h3>

<p>Well, by the time when I was doing the upgrade everything was <a href="https://github.com/activerecord-hackery/squeel/issues/307">baaaaaaad</a>. So I decided to remove the Squeel to exclude this dependency and to finally make the upgrade. Nowadays Squeel <a href="https://github.com/activerecord-hackery/squeel/pull/317">supports</a> Rails 4.1 (and as I know Rails 4.2 alpha). Yep, I am so lucky that when I has removed Squeel from the project, then it received Rails 4.1 support. Such fail. So &lsquo;lucky&rsquo;. Wow.</p>

<h3>Acts As Taggable</h3>

<p>You may have such exceptions:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>wrong number of arguments (1 for 2)</span></code></pre></td></tr></table></div></figure>


<p>For the method <code>tagged_with</code>. To solve this problem you need to update the gem version and run new migration:</p>

<figure class='code'><figcaption><span>Gemfile </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;acts-as-taggable-on&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 3.2.6&#39;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Terminal </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>bundle
</span><span class='line'><span class="nv">$ </span>rake acts_as_taggable_on_engine:install:migrations
</span><span class='line'><span class="nv">$ </span>rake db:migrate
</span></code></pre></td></tr></table></div></figure>


<h3>Thinking Sphinx</h3>

<p>Comment the thinking sphinx gem after the upgrade and bundle:</p>

<figure class='code'><figcaption><span>Gemfile </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#gem &#39;thinking-sphinx&#39;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Terminal </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>bundle
</span></code></pre></td></tr></table></div></figure>


<p>Then install this specific version from the brunch on github:</p>

<figure class='code'><figcaption><span>Gemfile </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;thinking-sphinx&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 3.1.1&#39;</span><span class="p">,</span> <span class="ss">git</span><span class="p">:</span> <span class="s1">&#39;git://github.com/pat/thinking-sphinx.git&#39;</span><span class="p">,</span> <span class="ss">branch</span><span class="p">:</span> <span class="s1">&#39;develop&#39;</span><span class="p">,</span> <span class="ss">ref</span><span class="p">:</span> <span class="s1">&#39;c8f549f689&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This version includes many fixes for Rails 4.1, including fixes for polymorphic associations (yep, I found few bugs and posted them to Pat, he fixed everything. And this is awesome!).</p>

<h3>Rails-admin</h3>

<p>If you use <code>0.6.2</code> version and Rails 4.1.2 then you&rsquo;ll meet this exception if you&rsquo;ll try to create record in admin&rsquo;s panel:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ActiveModel::ForbiddenAttributesError</span></code></pre></td></tr></table></div></figure>


<p>Because new version hasn&rsquo;t been released yet, you need to install specific version from master:</p>

<figure class='code'><figcaption><span>Gemfile </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;rails_admin&#39;</span><span class="p">,</span> <span class="s1">&#39;0.6.2&#39;</span><span class="p">,</span> <span class="ss">git</span><span class="p">:</span> <span class="s1">&#39;git://github.com/sferik/rails_admin.git&#39;</span><span class="p">,</span> <span class="ss">branch</span><span class="p">:</span> <span class="s1">&#39;master&#39;</span><span class="p">,</span> <span class="ss">ref</span><span class="p">:</span> <span class="s1">&#39;02ba1dab32d&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>_attributes</h3>

<p>Well, I think a lot of people have ever used nested attributes. So, if you&rsquo;ll create nested params in form manually then this topic may be interesting for you. The thing is that you can&rsquo;t pass data like in that way:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="p">{</span><span class="n">some_data</span><span class="p">:</span> <span class="p">{</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">}}</span>
</span></code></pre></td></tr></table></div></figure>


<p>You need to pass it by this way:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="p">{</span><span class="n">some_data_attributes</span><span class="p">:</span> <span class="p">{</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">}}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Yes, it&rsquo;s Rails-way and bla-bla-bla. But the thing is that key <code>some_data</code> WORKED somehow before, which is weird. But the most weird thing is that if you&rsquo;ll continue to use it then you&rsquo;ll receive this super weird exception:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Expected</span> <span class="no">SomeData</span> <span class="n">but</span> <span class="n">received</span> <span class="nb">Array</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, now you know what that mean. I wasted A LOT of hours trying to debug that.</p>

<h3>Spring</h3>

<p>Spring is app preloader, which is built in Rails core now. It allows you to speed up running task (such as Rails console), which is very nice. Installation is simple:</p>

<figure class='code'><figcaption><span>Gemfile </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;spring&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Terminal </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>bundle
</span><span class='line'><span class="nv">$ </span>bundle <span class="nb">exec </span>spring binstub --all
</span></code></pre></td></tr></table></div></figure>


<p>After that you can install binstubs for cucumber and rspec. You know, just for fun (even if you don&rsquo;t have them, ha):</p>

<figure class='code'><figcaption><span>Gemfile </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;spring-commands-rspec&#39;</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;spring-commands-cucumber&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Terminal </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>bundle <span class="nb">exec </span>spring binstub cucumber
</span><span class='line'><span class="nv">$ </span>bundle <span class="nb">exec </span>spring binstub rspec
</span><span class='line'><span class="nv">$ </span>spring stop
</span></code></pre></td></tr></table></div></figure>


<p>Now you can run your tests. Don&rsquo;t forger to run them via <code>bin/rspec</code> and <code>bin/cucumber</code> to use Spring. There is one gotcha with Spring, which you can read about in the next section.</p>

<h3>Parallel_tests</h3>

<p>Here is the gotcha. It doesn&rsquo;t work with Spring. It&rsquo;s very, very sad. Why? Because parallel_test is big help for you tests. Read <a href="https://github.com/grosser/parallel_tests">here more why it awesome</a>.</p>

<p>So, you&rsquo;ll get such exceptions:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Failure</span><span class="o">/</span><span class="ss">Error</span><span class="p">:</span> <span class="no">Unable</span> <span class="n">to</span> <span class="n">find</span> <span class="n">matching</span> <span class="n">line</span> <span class="n">from</span> <span class="n">backtrace</span>
</span><span class='line'>     <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:StatementInvalid</span><span class="p">:</span>
</span><span class='line'>       <span class="ss">PG</span><span class="p">:</span><span class="ss">:TRDeadlockDetected</span><span class="p">:</span> <span class="ss">ERROR</span><span class="p">:</span>  <span class="n">deadlock</span> <span class="n">detected</span>
</span><span class='line'>       <span class="no">LINE</span> <span class="mi">1</span><span class="p">:</span> <span class="no">SELECT</span>  <span class="s2">&quot;contact_types&quot;</span><span class="o">.</span><span class="n">*</span> <span class="no">FROM</span> <span class="s2">&quot;contact_types&quot;</span>  <span class="no">WHERE</span> <span class="s2">&quot;conta...</span>
</span><span class='line'><span class="s2">                                              ^</span>
</span><span class='line'><span class="s2">       DETAIL:  Process 70359 waits for AccessShareLock on relation 24882218 of database 7594218; blocked by process 70358.</span>
</span><span class='line'><span class="s2">       Process 70358 waits for AccessExclusiveLock on relation 24888649 of database 7594218; blocked by process 70359.</span>
</span><span class='line'><span class="s2">       HINT:  See server log for query details.</span>
</span></code></pre></td></tr></table></div></figure>


<p>But there is workaround! Open <code>config/spring.rb</code> and paste:</p>

<figure class='code'><figcaption><span>config/spring.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s2">&quot;active_support/core_ext/module/aliasing&quot;</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;spring/application&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Spring</span><span class="o">::</span><span class="no">Application</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">connect_database_with_reconfigure_database</span>
</span><span class='line'>    <span class="n">disconnect_database</span>
</span><span class='line'>    <span class="n">reconfigure_database</span>
</span><span class='line'>    <span class="n">connect_database_without_reconfigure_database</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">alias_method_chain</span> <span class="ss">:connect_database</span><span class="p">,</span> <span class="ss">:reconfigure_database</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">reconfigure_database</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">active_record_configured?</span>
</span><span class='line'>      <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span><span class="o">.</span><span class="n">configurations</span> <span class="o">=</span> <span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">database_configuration</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then stop the spring, so he could see these code above:</p>

<figure class='code'><figcaption><span>Terminal </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>spring stop
</span></code></pre></td></tr></table></div></figure>


<p>And now you run tests in parallel.</p>

<h3>Strong Params</h3>

<p>I don&rsquo;t know how many people may meet my situation, but anyway. If you build your nested attributes hash in form manually, then (and only then) there is possible situation when keys in your hash may contain hashes and/or integer. For example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="p">{</span><span class="ss">:service</span> <span class="o">=&gt;</span>
</span><span class='line'>  <span class="p">{</span><span class="ss">:shipping_locations_attributes</span> <span class="o">=&gt;</span>
</span><span class='line'>    <span class="p">{</span><span class="err">“</span><span class="n">w234pxc453</span><span class="err">”</span><span class="o">=&gt;</span>
</span><span class='line'>      <span class="p">{</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;LA, USA&quot;</span><span class="p">,</span>
</span><span class='line'>       <span class="ss">:longitude</span> <span class="o">=&gt;</span> <span class="s2">&quot;37.6173&quot;</span><span class="p">,</span>
</span><span class='line'>       <span class="ss">:latitude</span> <span class="o">=&gt;</span> <span class="s2">&quot;32.755826&quot;</span><span class="p">},</span>
</span><span class='line'>    <span class="s2">&quot;0&quot;</span><span class="o">=&gt;</span>
</span><span class='line'>      <span class="p">{</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;LC, USA&quot;</span><span class="p">,</span>
</span><span class='line'>       <span class="ss">:longitude</span> <span class="o">=&gt;</span> <span class="s2">&quot;12.6173&quot;</span><span class="p">,</span>
</span><span class='line'>       <span class="ss">:latitude</span> <span class="o">=&gt;</span> <span class="s2">&quot;58.755826&quot;</span><span class="p">}</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In my case there is 3 possible situations:</p>

<ol>
<li>All keys are integers.</li>
<li>All keys are hashes.</li>
<li>Keys are hashes AND integers.</li>
</ol>


<p>You may think that this would work:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:service</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:type_professional</span><span class="p">)</span><span class="o">.</span><span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">whitelist</span><span class="o">|</span>
</span><span class='line'>  <span class="n">whitelist</span><span class="o">[</span><span class="ss">:shipping_locations_attributes</span><span class="o">]</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:service</span><span class="o">][</span><span class="ss">:shipping_locations_attributes</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Unfortunately, it didn&rsquo;t help me (but it may help you). That is why I have created special method, which knows about these 3 possible situations and it generates array with this data dynamically, so you just insert this data in <code>permit</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="c1"># Pair keys (which StronParams doesn&#39;t allow to use for nested attributes) with data to permit.</span>
</span><span class='line'>  <span class="c1"># Input:</span>
</span><span class='line'>  <span class="c1">#   keys - Array - keys, which need to be appear in result.</span>
</span><span class='line'>  <span class="c1">#   data_to_permit - Array/Integer/String/etc - data, which need to be in result as value.</span>
</span><span class='line'>  <span class="c1">#</span>
</span><span class='line'>  <span class="c1"># Return:</span>
</span><span class='line'>  <span class="c1">#   1) Array with hash, where keys is input keys and values are duplicated data_to_permit IF all keys are not integers.</span>
</span><span class='line'>  <span class="c1">#   2) data_to_permit - if all keys are integer (otherwise data will not be permitted).</span>
</span><span class='line'>  <span class="c1">#</span>
</span><span class='line'>  <span class="c1"># Example:</span>
</span><span class='line'>  <span class="c1">#   pair_random_keys_with_data_to_permit([&quot;1a0f08fcbc&quot;, &quot;345rec32c1&quot;], [:id, :desc, :number])</span>
</span><span class='line'>  <span class="c1">#   # =&gt; [{:&quot;1a0f08fcbc&quot;=&gt;[:id, :desc, :number], :&quot;345rec32c1&quot;=&gt;[:id, :desc, :number]}]</span>
</span><span class='line'>  <span class="c1">#</span>
</span><span class='line'>  <span class="c1">#   pair_random_keys_with_data_to_permit([&quot;0&quot;, &quot;1&quot;], [:id, :desc, :number])</span>
</span><span class='line'>  <span class="c1">#   # =&gt; [:id, :desc, :number]</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">pair_random_keys_with_data_to_permit</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">data_to_permit</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="o">[]</span> <span class="k">if</span> <span class="n">keys</span><span class="o">.</span><span class="n">nil?</span> <span class="o">||</span> <span class="n">data_to_permit</span><span class="o">.</span><span class="n">nil?</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">keys_integers</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">all?</span><span class="p">{</span> <span class="o">|</span><span class="n">key</span><span class="o">|</span> <span class="n">key</span><span class="o">.</span><span class="n">to_i</span><span class="o">.</span><span class="n">to_s</span> <span class="o">==</span> <span class="n">key</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># When keys are all integers, then we should return data_to_permit, Rails&#39;s StrongParams</span>
</span><span class='line'>    <span class="c1"># will take care of it.</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">keys_integers</span>
</span><span class='line'>      <span class="n">data_to_permit</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">array_for_hash_to_permit</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">map</span><span class="p">{</span> <span class="o">|</span><span class="n">key</span><span class="o">|</span> <span class="o">[</span><span class="n">key</span><span class="p">,</span> <span class="n">data_to_permit</span><span class="o">]</span> <span class="p">}</span>                          <span class="c1"># Pair each key with data to permit.</span>
</span><span class='line'>      <span class="o">[</span><span class="no">Hash</span><span class="o">[</span><span class="n">array_for_hash_to_permit</span><span class="o">].</span><span class="n">symbolize_keys</span><span class="o">]</span>                                             <span class="c1"># Array with hash where keys are symbols (if they may be symbols).</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is the example how to use this method. You just pass a data to the method and then you should use it&rsquo;s results to permit it.</p>

<figure class='code'><figcaption><span>app/controllers/services_controller.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">service_params</span>
</span><span class='line'>    <span class="n">shipping_locations_keys</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:service</span><span class="o">][</span><span class="ss">:shipping_locations_attributes</span><span class="o">].</span><span class="n">try</span><span class="p">(</span><span class="ss">:keys</span><span class="p">)</span>
</span><span class='line'>    <span class="n">shipping_locations_allowed_attributes</span> <span class="o">=</span> <span class="o">[</span><span class="ss">:id</span><span class="p">,</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:longitude</span><span class="p">,</span> <span class="ss">:latitude</span><span class="o">]</span>
</span><span class='line'>    <span class="n">shipping_locations_attrs</span> <span class="o">=</span> <span class="n">pair_random_keys_with_data_to_permit</span><span class="p">(</span><span class="n">shipping_locations_keys</span><span class="p">,</span> <span class="n">shipping_locations_allowed_attributes</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:service</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:type_professional</span><span class="p">,</span> <span class="n">shipping_locations_attributes</span><span class="p">:</span> <span class="n">shipping_locations_attrs</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I hope it&rsquo;ll help somebody.</p>

<h3>Rails 4.1.5 notes</h3>

<p>When you upgrade your app to Rails 4.1.5 and you use Devise for authentication, then you can met this problem, when user tries to resend password:</p>

<figure class='code'><figcaption><span>Terminal </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ActiveModel::ForbiddenAttributesError - ActiveModel::ForbiddenAttributesError:
</span><span class='line'>  activemodel <span class="o">(</span>4.1.5<span class="o">)</span> lib/active_model/forbidden_attributes_protection.rb:21:in <span class="sb">`</span>sanitize_for_mass_assignment<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  activerecord (4.1.5) lib/active_record/relation/query_methods.rb:568:in `where!&#39;</span>
</span><span class='line'>  activerecord <span class="o">(</span>4.1.5<span class="o">)</span> lib/active_record/relation/query_methods.rb:559:in <span class="sb">`</span>where<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  activerecord (4.1.5) lib/active_record/querying.rb:10:in `where&#39;</span>
</span><span class='line'>  app/models/user.rb:83:in <span class="sb">`</span>find_first_by_auth_conditions<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  devise (3.2.4) lib/devise/models/authenticatable.rb:260:in `find_or_initialize_with_errors&#39;</span>
</span><span class='line'>  devise <span class="o">(</span>3.2.4<span class="o">)</span> lib/devise/models/recoverable.rb:99:in <span class="sb">`</span>send_reset_password_instructions<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  app/controllers/passwords_controller.rb:4:in `create&#39;</span>
</span><span class='line'>  actionpack <span class="o">(</span>4.1.5<span class="o">)</span> lib/action_controller/metal/implicit_render.rb:4:in <span class="sb">`</span>send_action<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  actionpack (4.1.5) lib/abstract_controller/base.rb:189:in `process_action&#39;</span>
</span><span class='line'>  actionpack <span class="o">(</span>4.1.5<span class="o">)</span> lib/action_controller/metal/rendering.rb:10:in <span class="sb">`</span>process_action<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  actionpack (4.1.5) lib/abstract_controller/callbacks.rb:20:in `block in process_action&#39;</span>
</span><span class='line'>  activesupport <span class="o">(</span>4.1.5<span class="o">)</span> lib/active_support/callbacks.rb:113:in <span class="sb">`</span>call<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  activesupport (4.1.5) lib/active_support/callbacks.rb:149:in `block in halting_and_conditional&#39;</span>
</span><span class='line'>  activesupport <span class="o">(</span>4.1.5<span class="o">)</span> lib/active_support/callbacks.rb:229:in <span class="sb">`</span>block in halting<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  activesupport (4.1.5) lib/active_support/callbacks.rb:166:in `block in halting&#39;</span>
</span><span class='line'>  activesupport <span class="o">(</span>4.1.5<span class="o">)</span> lib/active_support/callbacks.rb:166:in <span class="sb">`</span>block in halting<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  activesupport (4.1.5) lib/active_support/callbacks.rb:166:in `block in halting&#39;</span>
</span><span class='line'>  activesupport <span class="o">(</span>4.1.5<span class="o">)</span> lib/active_support/callbacks.rb:166:in <span class="sb">`</span>block in halting<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  activesupport (4.1.5) lib/active_support/callbacks.rb:229:in `block in halting&#39;</span>
</span><span class='line'>  activesupport <span class="o">(</span>4.1.5<span class="o">)</span> lib/active_support/callbacks.rb:166:in <span class="sb">`</span>block in halting<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  activesupport (4.1.5) lib/active_support/callbacks.rb:166:in `block in halting&#39;</span>
</span><span class='line'>  activesupport <span class="o">(</span>4.1.5<span class="o">)</span> lib/active_support/callbacks.rb:166:in <span class="sb">`</span>block in halting<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  activesupport (4.1.5) lib/active_support/callbacks.rb:166:in `block in halting&#39;</span>
</span><span class='line'>  activesupport <span class="o">(</span>4.1.5<span class="o">)</span> lib/active_support/callbacks.rb:166:in <span class="sb">`</span>block in halting<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  activesupport (4.1.5) lib/active_support/callbacks.rb:166:in `block in halting&#39;</span>
</span><span class='line'>  activesupport <span class="o">(</span>4.1.5<span class="o">)</span> lib/active_support/callbacks.rb:166:in <span class="sb">`</span>block in halting<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  activesupport (4.1.5) lib/active_support/callbacks.rb:166:in `block in halting&#39;</span>
</span><span class='line'>  activesupport <span class="o">(</span>4.1.5<span class="o">)</span> lib/active_support/callbacks.rb:86:in <span class="sb">`</span>run_callbacks<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  actionpack (4.1.5) lib/abstract_controller/callbacks.rb:19:in `process_action&#39;</span>
</span><span class='line'>  actionpack <span class="o">(</span>4.1.5<span class="o">)</span> lib/action_controller/metal/rescue.rb:29:in <span class="sb">`</span>process_action<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  actionpack (4.1.5) lib/action_controller/metal/instrumentation.rb:31:in `block in process_action&#39;</span>
</span><span class='line'>  activesupport <span class="o">(</span>4.1.5<span class="o">)</span> lib/active_support/notifications.rb:159:in <span class="sb">`</span>block in instrument<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  activesupport (4.1.5) lib/active_support/notifications/instrumenter.rb:20:in `instrument&#39;</span>
</span><span class='line'>  activesupport <span class="o">(</span>4.1.5<span class="o">)</span> lib/active_support/notifications.rb:159:in <span class="sb">`</span>instrument<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  actionpack (4.1.5) lib/action_controller/metal/instrumentation.rb:30:in `process_action&#39;</span>
</span><span class='line'>  actionpack <span class="o">(</span>4.1.5<span class="o">)</span> lib/action_controller/metal/params_wrapper.rb:250:in <span class="sb">`</span>process_action<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  activerecord (4.1.5) lib/active_record/railties/controller_runtime.rb:18:in `process_action&#39;</span>
</span><span class='line'>  actionpack <span class="o">(</span>4.1.5<span class="o">)</span> lib/abstract_controller/base.rb:136:in <span class="sb">`</span>process<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  actionview (4.1.5) lib/action_view/rendering.rb:30:in `process&#39;</span>
</span><span class='line'>  actionpack <span class="o">(</span>4.1.5<span class="o">)</span> lib/action_controller/metal.rb:196:in <span class="sb">`</span>dispatch<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  actionpack (4.1.5) lib/action_controller/metal/rack_delegation.rb:13:in `dispatch&#39;</span>
</span><span class='line'>  actionpack <span class="o">(</span>4.1.5<span class="o">)</span> lib/action_controller/metal.rb:232:in <span class="sb">`</span>block in action<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  actionpack (4.1.5) lib/action_dispatch/routing/route_set.rb:82:in `dispatch&#39;</span>
</span><span class='line'>  actionpack <span class="o">(</span>4.1.5<span class="o">)</span> lib/action_dispatch/routing/route_set.rb:50:in <span class="sb">`</span>call<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  actionpack (4.1.5) lib/action_dispatch/routing/mapper.rb:45:in `call&#39;</span>
</span><span class='line'>  actionpack <span class="o">(</span>4.1.5<span class="o">)</span> lib/action_dispatch/journey/router.rb:71:in <span class="sb">`</span>block in call<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  actionpack (4.1.5) lib/action_dispatch/journey/router.rb:59:in `call&#39;</span>
</span><span class='line'>  actionpack <span class="o">(</span>4.1.5<span class="o">)</span> lib/action_dispatch/routing/route_set.rb:678:in <span class="sb">`</span>call<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  rack-pjax (0.7.0) lib/rack/pjax.rb:12:in `call&#39;</span>
</span><span class='line'>  newrelic_rpm <span class="o">(</span>3.8.1.221<span class="o">)</span> lib/new_relic/rack/error_collector.rb:55:in <span class="sb">`</span>call<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  newrelic_rpm (3.8.1.221) lib/new_relic/rack/agent_hooks.rb:32:in `call&#39;</span>
</span><span class='line'>  newrelic_rpm <span class="o">(</span>3.8.1.221<span class="o">)</span> lib/new_relic/rack/browser_monitoring.rb:27:in <span class="sb">`</span>call<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  newrelic_rpm (3.8.1.221) lib/new_relic/rack/developer_mode.rb:45:in `call&#39;</span>
</span><span class='line'>  meta_request <span class="o">(</span>0.3.0<span class="o">)</span> lib/meta_request/middlewares/app_request_handler.rb:13:in <span class="sb">`</span>call<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  rack-contrib (1.1.0) lib/rack/contrib/response_headers.rb:17:in `call&#39;</span>
</span><span class='line'>  meta_request <span class="o">(</span>0.3.0<span class="o">)</span> lib/meta_request/middlewares/headers.rb:16:in <span class="sb">`</span>call<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  meta_request (0.3.0) lib/meta_request/middlewares/meta_request_handler.rb:13:in `call&#39;</span>
</span><span class='line'>  bullet <span class="o">(</span>4.10.0<span class="o">)</span> lib/bullet/rack.rb:12:in <span class="sb">`</span>call<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  simple_captcha2 (0.3.2) lib/simple_captcha/middleware.rb:26:in `call&#39;</span>
</span><span class='line'>  warden <span class="o">(</span>1.2.3<span class="o">)</span> lib/warden/manager.rb:35:in <span class="sb">`</span>block in call<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  warden (1.2.3) lib/warden/manager.rb:34:in `call&#39;</span>
</span><span class='line'>  rack <span class="o">(</span>1.5.2<span class="o">)</span> lib/rack/etag.rb:23:in <span class="sb">`</span>call<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  rack (1.5.2) lib/rack/conditionalget.rb:35:in `call&#39;</span>
</span><span class='line'>  rack <span class="o">(</span>1.5.2<span class="o">)</span> lib/rack/head.rb:11:in <span class="sb">`</span>call<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  remotipart (1.2.1) lib/remotipart/middleware.rb:27:in `call&#39;</span>
</span><span class='line'>  actionpack <span class="o">(</span>4.1.5<span class="o">)</span> lib/action_dispatch/middleware/params_parser.rb:27:in <span class="sb">`</span>call<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  actionpack (4.1.5) lib/action_dispatch/middleware/flash.rb:254:in `call&#39;</span>
</span><span class='line'>  rack <span class="o">(</span>1.5.2<span class="o">)</span> lib/rack/session/abstract/id.rb:225:in <span class="sb">`</span>context<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  rack (1.5.2) lib/rack/session/abstract/id.rb:220:in `call&#39;</span>
</span><span class='line'>  actionpack <span class="o">(</span>4.1.5<span class="o">)</span> lib/action_dispatch/middleware/cookies.rb:560:in <span class="sb">`</span>call<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  activerecord (4.1.5) lib/active_record/query_cache.rb:36:in `call&#39;</span>
</span><span class='line'>  activerecord <span class="o">(</span>4.1.5<span class="o">)</span> lib/active_record/connection_adapters/abstract/connection_pool.rb:621:in <span class="sb">`</span>call<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  activerecord (4.1.5) lib/active_record/migration.rb:380:in `call&#39;</span>
</span><span class='line'>  actionpack <span class="o">(</span>4.1.5<span class="o">)</span> lib/action_dispatch/middleware/callbacks.rb:29:in <span class="sb">`</span>block in call<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  activesupport (4.1.5) lib/active_support/callbacks.rb:82:in `run_callbacks&#39;</span>
</span><span class='line'>  actionpack <span class="o">(</span>4.1.5<span class="o">)</span> lib/action_dispatch/middleware/callbacks.rb:27:in <span class="sb">`</span>call<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  actionpack (4.1.5) lib/action_dispatch/middleware/reloader.rb:73:in `call&#39;</span>
</span><span class='line'>  actionpack <span class="o">(</span>4.1.5<span class="o">)</span> lib/action_dispatch/middleware/remote_ip.rb:76:in <span class="sb">`</span>call<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  better_errors (1.1.0) lib/better_errors/middleware.rb:84:in `protected_app_call&#39;</span>
</span><span class='line'>  better_errors <span class="o">(</span>1.1.0<span class="o">)</span> lib/better_errors/middleware.rb:79:in <span class="sb">`</span>better_errors_call<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  better_errors (1.1.0) lib/better_errors/middleware.rb:56:in `call&#39;</span>
</span><span class='line'>  actionpack <span class="o">(</span>4.1.5<span class="o">)</span> lib/action_dispatch/middleware/debug_exceptions.rb:17:in <span class="sb">`</span>call<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  actionpack (4.1.5) lib/action_dispatch/middleware/show_exceptions.rb:30:in `call&#39;</span>
</span><span class='line'>  railties <span class="o">(</span>4.1.5<span class="o">)</span> lib/rails/rack/logger.rb:38:in <span class="sb">`</span>call_app<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  railties (4.1.5) lib/rails/rack/logger.rb:20:in `block in call&#39;</span>
</span><span class='line'>  activesupport <span class="o">(</span>4.1.5<span class="o">)</span> lib/active_support/tagged_logging.rb:68:in <span class="sb">`</span>block in tagged<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  activesupport (4.1.5) lib/active_support/tagged_logging.rb:26:in `tagged&#39;</span>
</span><span class='line'>  activesupport <span class="o">(</span>4.1.5<span class="o">)</span> lib/active_support/tagged_logging.rb:68:in <span class="sb">`</span>tagged<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  railties (4.1.5) lib/rails/rack/logger.rb:20:in `call&#39;</span>
</span><span class='line'>  quiet_assets <span class="o">(</span>1.0.3<span class="o">)</span> lib/quiet_assets.rb:23:in <span class="sb">`</span>call_with_quiet_assets<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  actionpack (4.1.5) lib/action_dispatch/middleware/request_id.rb:21:in `call&#39;</span>
</span><span class='line'>  request_store <span class="o">(</span>1.0.6<span class="o">)</span> lib/request_store/middleware.rb:8:in <span class="sb">`</span>call<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  rack (1.5.2) lib/rack/methodoverride.rb:21:in `call&#39;</span>
</span><span class='line'>  rack <span class="o">(</span>1.5.2<span class="o">)</span> lib/rack/runtime.rb:17:in <span class="sb">`</span>call<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  activesupport (4.1.5) lib/active_support/cache/strategy/local_cache_middleware.rb:26:in `call&#39;</span>
</span><span class='line'>  rack <span class="o">(</span>1.5.2<span class="o">)</span> lib/rack/lock.rb:17:in <span class="sb">`</span>call<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  actionpack (4.1.5) lib/action_dispatch/middleware/static.rb:64:in `call&#39;</span>
</span><span class='line'>  rack <span class="o">(</span>1.5.2<span class="o">)</span> lib/rack/sendfile.rb:112:in <span class="sb">`</span>call<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  railties (4.1.5) lib/rails/engine.rb:514:in `call&#39;</span>
</span><span class='line'>  railties <span class="o">(</span>4.1.5<span class="o">)</span> lib/rails/application.rb:144:in <span class="sb">`</span>call<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  rack (1.5.2) lib/rack/content_length.rb:14:in `call&#39;</span>
</span><span class='line'>  thin <span class="o">(</span>1.6.2<span class="o">)</span> lib/thin/connection.rb:86:in <span class="sb">`</span>block in pre_process<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  thin (1.6.2) lib/thin/connection.rb:84:in `pre_process&#39;</span>
</span><span class='line'>  thin <span class="o">(</span>1.6.2<span class="o">)</span> lib/thin/connection.rb:53:in <span class="sb">`</span>process<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  thin (1.6.2) lib/thin/connection.rb:39:in `receive_data&#39;</span>
</span><span class='line'>  eventmachine <span class="o">(</span>1.0.3<span class="o">)</span> lib/eventmachine.rb:187:in <span class="sb">`</span>run<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  thin (1.6.2) lib/thin/backends/base.rb:73:in `start&#39;</span>
</span><span class='line'>  thin <span class="o">(</span>1.6.2<span class="o">)</span> lib/thin/server.rb:162:in <span class="sb">`</span>start<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  rack (1.5.2) lib/rack/handler/thin.rb:16:in `run&#39;</span>
</span><span class='line'>  rack <span class="o">(</span>1.5.2<span class="o">)</span> lib/rack/server.rb:264:in <span class="sb">`</span>start<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  railties (4.1.5) lib/rails/commands/server.rb:69:in `start&#39;</span>
</span><span class='line'>  railties <span class="o">(</span>4.1.5<span class="o">)</span> lib/rails/commands/commands_tasks.rb:81:in <span class="sb">`</span>block in server<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  railties (4.1.5) lib/rails/commands/commands_tasks.rb:76:in `server&#39;</span>
</span><span class='line'>  railties <span class="o">(</span>4.1.5<span class="o">)</span> lib/rails/commands/commands_tasks.rb:40:in <span class="sb">`</span>run_command!<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  railties (4.1.5) lib/rails/commands.rb:17:in `&lt;top (required)&gt;&#39;</span>
</span><span class='line'>  bin/rails:8:in <span class="sb">`</span>&lt;top <span class="o">(</span>required<span class="o">)</span>&gt;<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  spring (1.1.3) lib/spring/client/rails.rb:27:in `call&#39;</span>
</span><span class='line'>  spring <span class="o">(</span>1.1.3<span class="o">)</span> lib/spring/client/command.rb:7:in <span class="sb">`</span>call<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  spring (1.1.3) lib/spring/client.rb:26:in `run&#39;</span>
</span><span class='line'>  spring <span class="o">(</span>1.1.3<span class="o">)</span> bin/spring:48:in <span class="sb">`</span>&lt;top <span class="o">(</span>required<span class="o">)</span>&gt;<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  spring (1.1.3) lib/spring/binstub.rb:11:in `&lt;top (required)&gt;&#39;</span>
</span><span class='line'>  bin/spring:16:in <span class="sb">`</span>&lt;top <span class="o">(</span>required<span class="o">)</span>&gt;<span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  bin/rails:3:in `&lt;main&gt;&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>In my case I had overridden Devise&rsquo;s controller:</p>

<figure class='code'><figcaption><span>app/controllers/passwords_controller.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">PasswordsController</span> <span class="o">&lt;</span> <span class="ss">Devise</span><span class="p">:</span><span class="ss">:PasswordsController</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>    <span class="vi">@user</span> <span class="o">=</span> <span class="n">resource_class</span><span class="o">.</span><span class="n">send_reset_password_instructions</span><span class="p">(</span><span class="n">resource_params</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class='line'>      <span class="nb">format</span><span class="o">.</span><span class="n">js</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Fix is pretty easy. We need to permit email:</p>

<figure class='code'><figcaption><span>app/controllers/passwords_controller.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">PasswordsController</span> <span class="o">&lt;</span> <span class="ss">Devise</span><span class="p">:</span><span class="ss">:PasswordsController</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>    <span class="vi">@user</span> <span class="o">=</span> <span class="n">resource_class</span><span class="o">.</span><span class="n">send_reset_password_instructions</span><span class="p">(</span><span class="n">resource_params</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:email</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># ...</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Last words</h3>

<p>Check out <a href="http://railsdiff.org/diff/v4.0.5/v4.1.5/">railsdiff</a> to view changes in the code. Don&rsquo;t forget to bump you gems. Make sure that all tests are green. Have a good test coverage and don&rsquo;t bump your app without it.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How Thor Can Help You With Your Tests (or Integration of Parallel_tests and Cucumber)]]></title>
    <link href="http://bloginius.com/blog/2014/05/12/how-thor-can-help-you-with-your-tests-or-integration-of-parallel-tests-and-cucumber/"/>
    <updated>2014-05-12T18:05:53+04:00</updated>
    <id>http://bloginius.com/blog/2014/05/12/how-thor-can-help-you-with-your-tests-or-integration-of-parallel-tests-and-cucumber</id>
    <content type="html"><![CDATA[<h2>Specs it!</h2>

<p>Today I&rsquo;d like to talk about one important (kind of) area of each RoR developer. This is testing. You may wonder, &ldquo;Why the heck do I even need to write these stupid tests?”. Well, first of all, you may do it because your boss wants it. Or because all other rubyists write them. What do you mean, &#8220;I&rsquo;m not satisfied?”. All right, how about making sure that your app don&rsquo;t crush each time you commit new feature or fix a bug? Tests also help you to upgrade libs, install new Rails and other funny stuff, FYI. I know the company, who can&rsquo;t upgrade to Rails 4, because it&rsquo;s app don&rsquo;t have tests.</p>

<p>Let me suppose, that you are satisfied by that and you started to write tests&hellip; Firstly with Rspec, because test-unit is not popular solution. And then you open Cucumber for yourself. And write more and more tests. And in one day you look in your terminal and you start to think that waiting 10 minutes until your features&rsquo;d finish isn&rsquo;t a good idea, because you can already drink few cups of tea or coffee and with such progress soon you&rsquo;ll be able to watch a &ldquo;Big bang theory”.</p>

<p><img class="center" src="http://bloginius.com/images/thor-and-parallel-tests/cucumber-running-xkcd.png"></p>

<!-- more -->


<p>And you decide to make your tests faster. So, you google for a while and find <a href="https://github.com/grosser/parallel_tests">parallel_tests</a>. You try it and see that your tests run <em>n</em> times faster! Wow!</p>

<p>You start use it, and use, it and use it. But after a while some of your tests <em>suddenly</em> start to fail from time to time. You fight with it, even add hacks: <code>sleep 100500</code>. And even with that some tests may fail randomly from time to time. Oh&hellip;</p>

<p><img class="center" src="http://bloginius.com/images/thor-and-parallel-tests/doge-wow-cucumber.jpeg"></p>

<p>Of course, you still should try to fix it. But fixing randomly failing piece of code is one of the hardest things that you can ever meet in your live as a programmer, in my humble opinion.</p>

<h2>Thor with parallel</h2>

<p>So, I decided to create a thor task for people, who use <a href="https://github.com/grosser/parallel_tests">parallel_tests</a>. This tool do this:</p>

<ol>
<li>Prepare your databases in parallel.</li>
<li>Run your features in parallel.</li>
<li>Rerun failed tests with vanilla cucumber.</li>
</ol>


<p>Here is the code:</p>

<figure class='code'><figcaption><span>lib/tasks/parallel.thor </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">&#39;config/environment.rb&#39;</span><span class="p">)</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;cucumber/cli/main&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;parallel_tests&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Parallel</span> <span class="o">&lt;</span> <span class="ss">Gearup</span><span class="p">:</span><span class="ss">:TasksBase</span>
</span><span class='line'>  <span class="n">desc</span> <span class="s2">&quot;and_rerun&quot;</span><span class="p">,</span> <span class="s1">&#39;Prepare and run tests in parallel, and restart failed tests via vanilla cucumber. Run it like that: $ RAILS_ENV=test bundle exec thor parallel:and_rerun&#39;</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">and_rerun</span>
</span><span class='line'>    <span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">test?</span>
</span><span class='line'>      <span class="k">begin</span>
</span><span class='line'>        <span class="nb">puts</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Run: rake parallel:prepare&quot;</span>
</span><span class='line'>        <span class="nb">puts</span> <span class="sb">`rake parallel:prepare`</span>
</span><span class='line'>
</span><span class='line'>        <span class="nb">puts</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Run: rake parallel:features&quot;</span>
</span><span class='line'>        <span class="ss">ParallelTests</span><span class="p">:</span><span class="ss">:CLI</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">[</span><span class="s2">&quot;--type&quot;</span><span class="p">,</span> <span class="s2">&quot;cucumber&quot;</span><span class="o">]</span> <span class="o">+</span> <span class="o">[</span><span class="s2">&quot;features&quot;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>      <span class="k">ensure</span>                                                                                        <span class="c1"># Run fail tests if ParallelTests raised error (which it does when some tests fail).</span>
</span><span class='line'>        <span class="nb">puts</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Checking for failed tests...&quot;</span>
</span><span class='line'>        <span class="n">rerun_with_cucumber</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="k">raise</span> <span class="s2">&quot;You didn&#39;t run task in test environment! Run it like that: $ RAILS_ENV=test bundle exec thor parallel:and_rerun&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">desc</span> <span class="s2">&quot;rerun_with_cucumber&quot;</span><span class="p">,</span> <span class="s1">&#39;Run failed tests with vanilla cucumber (non-parallel)&#39;</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">rerun_with_cucumber</span>
</span><span class='line'>    <span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">test?</span>
</span><span class='line'>      <span class="n">parallel_file_with_failed_features</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;tmp&quot;</span><span class="p">,</span> <span class="s2">&quot;parallel_cucumber_failures.log&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">failed_features_str</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">parallel_file_with_failed_features</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span>
</span><span class='line'>      <span class="n">tmp_logs</span> <span class="o">=</span> <span class="no">Tempfile</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;parallel_cucumber_failures_tmp&#39;</span><span class="p">,</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;tmp&quot;</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">begin</span>
</span><span class='line'>        <span class="n">tmp_logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">failed_features_str</span><span class="p">)</span>
</span><span class='line'>        <span class="n">tmp_logs</span><span class="o">.</span><span class="n">rewind</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1"># Running failed tests if parallel file with failed features contains something.</span>
</span><span class='line'>        <span class="k">unless</span> <span class="n">failed_features_str</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>          <span class="n">cucumber_cmd</span> <span class="o">=</span> <span class="s2">&quot;@</span><span class="si">#{</span><span class="n">tmp_logs</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>          <span class="nb">puts</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Executing failed tests: cucumber </span><span class="si">#{</span><span class="n">cucumber_cmd</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>          <span class="ss">Cucumber</span><span class="p">:</span><span class="ss">:Cli</span><span class="o">::</span><span class="no">Main</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="n">cucumber_cmd</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">execute!</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>          <span class="nb">puts</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">There are no failed tests.&quot;</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">ensure</span>
</span><span class='line'>        <span class="n">tmp_logs</span><span class="o">.</span><span class="n">close</span>
</span><span class='line'>        <span class="n">tmp_logs</span><span class="o">.</span><span class="n">unlink</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="k">raise</span> <span class="s2">&quot;You didn&#39;t run task in test environment! Run it like that: $ RAILS_ENV=test bundle exec thor parallel:rerun_with_cucumber&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Well, code contains 2 methods: one to actually rerun failed tests and one to prepare db, run tests in parallel and then call task to run failed features. But this is not all.</p>

<p><img class="center" src="http://bloginius.com/images/thor-and-parallel-tests/evil-happy-kid.png"></p>

<p>To enable features to be actually reruned when they fail, you need to enable logging failed features by parallel_tests. This functional has been merged a while ago (wow), but you need to add a specific code to enable it.</p>

<p>Open config/cucumber.yml and add this <code>--format ParallelTests::Cucumber::FailuresLogger --out tmp/parallel_cucumber_failures.log</code> to std_options:</p>

<figure class='code'><figcaption><span>config/cucumber.yml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#...</span>
</span><span class='line'><span class="n">std_opts</span> <span class="o">=</span> <span class="s2">&quot;--format </span><span class="si">#{</span><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;CUCUMBER_FORMAT&#39;</span><span class="o">]</span> <span class="o">||</span> <span class="s1">&#39;pretty&#39;</span><span class="si">}</span><span class="s2"> --strict --tags ~@wip --require features --format ParallelTests::Cucumber::FailuresLogger --out tmp/parallel_cucumber_failures.log”</span>
</span><span class='line'><span class="s2">#...</span>
</span></code></pre></td></tr></table></div></figure>


<p>And after that you may run the thor task. Failed tests will be stored in <code>tmp/parallel_cucumber_failures.log</code> (where you can view them, if you want). To run the thor task print this:</p>

<figure class='code'><figcaption><span>Terminal </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ RAILS_ENV</span><span class="o">=</span><span class="nb">test </span>bundle <span class="nb">exec </span>thor parallel:and_rerun
</span></code></pre></td></tr></table></div></figure>


<p>This thor task has tested under:</p>

<ul>
<li>Rails 4</li>
<li>thor 0.18.1</li>
<li>parallel_tests 0.16.8</li>
<li>cucumber-rails 1.4.0</li>
<li>capybara 2.2.1.</li>
</ul>


<p>If your cucumber or parallel_tests has lower version than the listed ones, then there is a chance that my code wouldn&rsquo;t work (make sure that you have cucumber at least <strong>1.4.0</strong>).</p>

<h2>Task&rsquo;s internals</h2>

<p>Now, let me talk a little about the code. You can skip this section if you are just planning to use the task and nothing more, but I encourage you to read more!</p>

<p>First of all, let me look in the source code of <code>rerun_with_cucumber</code> task.</p>

<figure class='code'><figcaption><span>lib/tasks/parallel.thor </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="c1"># ...</span>
</span><span class='line'>  <span class="n">desc</span> <span class="s2">&quot;rerun_with_cucumber&quot;</span><span class="p">,</span> <span class="s1">&#39;Run failed tests with vanilla cucumber (non-parallel)&#39;</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">rerun_with_cucumber</span>
</span><span class='line'>    <span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">test?</span>
</span><span class='line'>      <span class="n">parallel_file_with_failed_features</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;tmp&quot;</span><span class="p">,</span> <span class="s2">&quot;parallel_cucumber_failures.log&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">failed_features_str</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">parallel_file_with_failed_features</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span>
</span><span class='line'>      <span class="n">tmp_logs</span> <span class="o">=</span> <span class="no">Tempfile</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;parallel_cucumber_failures_tmp&#39;</span><span class="p">,</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="p">,</span> <span class="s2">&quot;tmp&quot;</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">begin</span>
</span><span class='line'>        <span class="n">tmp_logs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">failed_features_str</span><span class="p">)</span>
</span><span class='line'>        <span class="n">tmp_logs</span><span class="o">.</span><span class="n">rewind</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1"># Running failed tests if parallel file with failed features contains something.</span>
</span><span class='line'>        <span class="k">unless</span> <span class="n">failed_features_str</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>          <span class="n">cucumber_cmd</span> <span class="o">=</span> <span class="s2">&quot;@</span><span class="si">#{</span><span class="n">tmp_logs</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>          <span class="nb">puts</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Executing failed tests: cucumber </span><span class="si">#{</span><span class="n">cucumber_cmd</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>          <span class="ss">Cucumber</span><span class="p">:</span><span class="ss">:Cli</span><span class="o">::</span><span class="no">Main</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">[</span><span class="n">cucumber_cmd</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">execute!</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>          <span class="nb">puts</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">There are no failed tests.&quot;</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>      <span class="k">ensure</span>
</span><span class='line'>        <span class="n">tmp_logs</span><span class="o">.</span><span class="n">close</span>
</span><span class='line'>        <span class="n">tmp_logs</span><span class="o">.</span><span class="n">unlink</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="k">raise</span> <span class="s2">&quot;You didn&#39;t run task in test environment! Run it like that: $ RAILS_ENV=test bundle exec thor parallel:rerun_with_cucumber&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>A lot of code for such task, isn&rsquo;t it? First of all, you can see that it check this:</p>

<figure class='code'><figcaption><span>lib/tasks/parallel.thor </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">test?</span>
</span></code></pre></td></tr></table></div></figure>


<p>Why? Because otherwise you may lose all your development data.</p>

<p><img class="center" src="http://bloginius.com/images/thor-and-parallel-tests/lose-local-meme.png"></p>

<p>Your task&rsquo;ll run with <code>RAILS_ENV=development</code>, because this is your current environment. This is the first thing. The second one is that you probably have <a href="https://github.com/bmabey/database_cleaner">database_cleaner</a> or you clean your test data by your own script. So, when you run your test with your current ENV (as development), you lose all data during your tests execution. That is why it&rsquo;s so important to specify <code>RAILS_ENV=test</code> when you execute the task and that is why the code is checking this case. It just protects you. Like Batman.</p>

<p>Second note. You may notice that code creates temporary file and that code uses this temp file to run failed tests. Why? As you may remember, I placed logger in the standard options in <code>cucumber.yml</code>. So, if you run your cucumber to execute failed tests, you&rsquo;ll receive nothing, and list of failed tests&rsquo;ll be immediately erased. To avoid that problem temporary file is using.</p>

<p>And the third note. You may wonder, why I call cucumber and parallel_tests directly and why I don&rsquo;t use ruby&rsquo;s <code>`cmd`</code> for that? Well, answer is simple. Because <code>`cmd`</code> in current case just sucks. First of all, you&rsquo;ll lose all colours in the terminal. Second thing is that <code>`cmd`</code> will return results only after command&rsquo;s finish. That means, if you have few slow tests then you&rsquo;ll just look at blank output for few minutes. And your colleagues&rsquo;d think that you are crazy. And you don&rsquo;t want that, even if you are crazy. Because, you know, you&rsquo;d listen stupid jokes about it and etc.</p>

<p>That is why the code uses direct call to the API. It gives you all advantages: colours, live execution, less stupid jokes. It behaves like it should.</p>

<p>That is all for today. Peace.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Useful Gems for Rails Developer. Part 1: Development]]></title>
    <link href="http://bloginius.com/blog/2014/04/18/useful-gems-for-rails-developer-part-1-development/"/>
    <updated>2014-04-18T17:31:57+04:00</updated>
    <id>http://bloginius.com/blog/2014/04/18/useful-gems-for-rails-developer-part-1-development</id>
    <content type="html"><![CDATA[<h2><a href="https://github.com/charliesome/better_errors">better_errors</a></h2>

<p>We meet different errors almost every day. Sometimes we get exceptions and we want to debug them to find the root of the problem. And better_errors helps us with that. It shows much nicer errors. It is like superman, just in programming area. And it is not just show stack trace to you, it also allows you to interact with your code and data using the console to get feedback immediately. It is nice, and I think, that you will get this feeling soon.</p>

<p><img class="center" src="http://bloginius.com/images/better-errors-preview.png"></p>

<!-- more -->


<p>Installation is very simple:</p>

<figure class='code'><figcaption><span>Gemfile </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s2">&quot;better_errors&quot;</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s2">&quot;binding_of_caller&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Yep, these 2 gems! You need second gem to enable advanced features of the better_errors: local/instance variable inspection, pretty stack frame names. Don’t be lazy, just copy and paste them.</p>

<p>And you should use these gems only in development mode, because, well you don’t want other people to access your data, do you?</p>

<h2><a href="https://github.com/evrone/quiet_assets">quiet_assets</a></h2>

<p>During our every day work we often look into Rails logs to understand why we don’t get what we want, or to see why page is loading so long (yeah, because of these 100500 joins). But, oh crap… So much time to scroll to the next controller’s response!</p>

<figure class='code'><figcaption><span>log/development.log </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Started</span> <span class="no">GET</span> <span class="s2">&quot;/assets/application.js?body=1&quot;</span> <span class="k">for</span> <span class="mi">127</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span> <span class="n">at</span> <span class="mi">2012</span><span class="o">-</span><span class="mo">02</span><span class="o">-</span><span class="mi">13</span> <span class="mi">13</span><span class="p">:</span><span class="mi">24</span><span class="p">:</span><span class="mo">04</span> <span class="o">+</span><span class="mo">0400</span>
</span><span class='line'><span class="no">Served</span> <span class="n">asset</span> <span class="sr">/application.js - 304 Not Modified (8ms)</span>
</span><span class='line'><span class="sr">…</span>
</span></code></pre></td></tr></table></div></figure>


<p>I really hate the fact, that vanilla Rails is so noisy with assets. Such long logs. So boring. Wow.</p>

<p><img class="center" src="http://bloginius.com/images/doge-meme.jpg"></p>

<p>Thanks to guy… Oh well, it is company. Thanks to guys from the company <em>Evrone</em> this pain is over. Install the gem:</p>

<figure class='code'><figcaption><span>Gemfile </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s2">&quot;quiet_assets&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And restart server. It is just that simple.</p>

<h2><a href="https://github.com/dejan/rails_panel/tree/master/meta_request">meta_request</a> &amp; rails_panel</h2>

<p>You pressed the &ldquo;Ok&rdquo; button and data has been sent to the server. New page appeared. Now you are wondering &ndash; why did you actually pressed this button? Oh, yeah, you need to check this edge case and find what server would respond, because last 10 exceptions on production happened because of you. And your boss is not happy!</p>

<p>Okay, you need to open terminal and scroll to this controller. But, oh, wait, first of all where is this icon? Here it is, and let me scroll for few seconds…
Okay, it is a little bit long. It is kinda boring repeat this movement again and again. So, you wondering is a any way to solve that?</p>

<p>Yes! It is rails_panel with meta_request. Idea is simple &ndash; you install the extension for your browser and then you install the gem so it would grab your data (and send it to the NSA, of course).</p>

<p>Install the gem:</p>

<figure class='code'><figcaption><span>Gemfile </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s2">&quot;meta_request&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And now you need install the actual extension. Well, it is for Google Chrome only. What? You use Firefox? Really? Are you hipster? How dare are you not to share your private data and passwords with Google! Install it immediately! And after that use that link: <a href="https://chrome.google.com/webstore/detail/railspanel/gjpfobpafnhjhbajcjgccbbdofdckggg.">https://chrome.google.com/webstore/detail/railspanel/gjpfobpafnhjhbajcjgccbbdofdckggg.</a> Yeap, I know, that this link is awesome.</p>

<h2><a href="https://github.com/flyerhzm/bullet">bullet</a></h2>

<p>As you may know, database request kinda expensive and may take a lot of time to render the page. Of course, it is not always the case, your app may may load so long because you decided to have 100500 share buttons on each page and such buttons loading synchronously.</p>

<p>But I really hope that you don’t do this.</p>

<p>So, for example you have list of items on your page and each item has owner. So you list such data on the page and if open your logs, you will see a lot of requests like this:</p>

<figure class='code'><figcaption><span>log/development.log </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">SELECT</span> <span class="s2">&quot;owners&quot;</span><span class="o">.</span><span class="n">*</span> <span class="no">FROM</span> <span class="s2">&quot;owners&quot;</span> <span class="no">WHERE</span> <span class="s2">&quot;owners&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span> <span class="o">=</span> <span class="vg">$1</span> <span class="no">ORDER</span> <span class="no">BY</span> <span class="s2">&quot;owners&quot;</span><span class="o">.</span><span class="s2">&quot;id&quot;</span> <span class="no">ASC</span> <span class="o">[[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="o">]]</span>
</span><span class='line'><span class="err">…</span>
</span></code></pre></td></tr></table></div></figure>


<p>Lists of such requests kill performance of your app. Users are angry, they leave your site, it generates less money, boss is angry, you are fired… What a nice picture!</p>

<p><img class="center" src="http://bloginius.com/images/hawkward.png"></p>

<p>To avoid such awkwardness you definitely need to install the bullet:</p>

<figure class='code'><figcaption><span>Gemfile </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">group</span><span class="p">:</span> <span class="s2">&quot;development&quot;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s2">&quot;bullet&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>After that you should create the initialiser:</p>

<figure class='code'><figcaption><span>config/environments/development.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">after_initialize</span> <span class="k">do</span>
</span><span class='line'>  <span class="no">Bullet</span><span class="o">.</span><span class="n">enable</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>  <span class="no">Bullet</span><span class="o">.</span><span class="n">alert</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>  <span class="no">Bullet</span><span class="o">.</span><span class="n">bullet_logger</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>  <span class="no">Bullet</span><span class="o">.</span><span class="n">console</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>  <span class="no">Bullet</span><span class="o">.</span><span class="n">growl</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>  <span class="no">Bullet</span><span class="o">.</span><span class="n">xmpp</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:account</span>  <span class="o">=&gt;</span> <span class="s1">&#39;bullets_account@jabber.org&#39;</span><span class="p">,</span>
</span><span class='line'>                  <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s1">&#39;bullets_password_for_jabber&#39;</span><span class="p">,</span>
</span><span class='line'>                  <span class="ss">:receiver</span> <span class="o">=&gt;</span> <span class="s1">&#39;your_account@jabber.org&#39;</span><span class="p">,</span>
</span><span class='line'>                  <span class="ss">:show_online_status</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span>
</span><span class='line'>  <span class="no">Bullet</span><span class="o">.</span><span class="n">rails_logger</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>  <span class="no">Bullet</span><span class="o">.</span><span class="n">airbrake</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>  <span class="no">Bullet</span><span class="o">.</span><span class="n">add_footer</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>  <span class="no">Bullet</span><span class="o">.</span><span class="n">stacktrace_includes</span> <span class="o">=</span> <span class="o">[</span> <span class="s1">&#39;your_gem&#39;</span><span class="p">,</span> <span class="s1">&#39;your_middleware&#39;</span> <span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>After that you will get such message:</p>

<figure class='code'><figcaption><span>log/development.log </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">2009</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">25</span> <span class="mi">20</span><span class="p">:</span><span class="mi">40</span><span class="p">:</span><span class="mi">17</span><span class="o">[</span><span class="no">INFO</span><span class="o">]</span> <span class="n">N</span><span class="o">+</span><span class="mi">1</span> <span class="ss">Query</span><span class="p">:</span> <span class="no">PATH_INFO</span><span class="p">:</span> <span class="sr">/items;    model: Item =&gt; associations: [owners]·</span>
</span><span class='line'><span class="sr">Add to your finder: :include =&gt; [:owners]</span>
</span><span class='line'><span class="sr">2009-08-25 20:40:17[INFO] N+1 Query: method call stack:·</span>
</span><span class='line'><span class="sr">…</span>
</span></code></pre></td></tr></table></div></figure>


<p>So you should do something like this in your controller:</p>

<figure class='code'><figcaption><span>app/conntrolles/items_controller.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#...</span>
</span><span class='line'><span class="vi">@items</span> <span class="o">=</span> <span class="no">Item</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="ss">:owners</span><span class="p">)</span>
</span><span class='line'><span class="c1">#...</span>
</span></code></pre></td></tr></table></div></figure>


<p>And your app would be much faster. Everybody is happy.</p>

<p>P.S. Good news, everyone! All gems, which are listed here, work with Rails 4! Peace!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Enlarge Your Capistrano]]></title>
    <link href="http://bloginius.com/blog/2014/02/24/enlarge-your-capistrano/"/>
    <updated>2014-02-24T14:58:45+04:00</updated>
    <id>http://bloginius.com/blog/2014/02/24/enlarge-your-capistrano</id>
    <content type="html"><![CDATA[<p>I would like to tell you about few gems, which would make your deployment life a little bit easier. Well, it worked for me.</p>

<h3>rvm-capistrano</h3>

<p>Our first hero on the scene is <a href="https://github.com/wayneeseguin/rvm-capistrano">rvm-capistrano</a>. This hero is special, he prefers only capistrano №2. But time is changing and capistrano №3 is walking on streets of our computers, so, if you have seen it and even use it then you may select another hero: <a href="https://github.com/rvm/rvm1-capistrano3#readme">rvm1-capistrano3</a>.</p>

<p>But I will talk about oldies here. What does this gem actually do? It brings integration between Rvm and capistrano. There are some discusses in the internet what to use, some people prefer <a href="https://github.com/sstephenson/rbenv">rbenv</a>, other use <a href="https://rvm.io/">Rvm</a>. Actually, rbenv is very small and it has very small code base, but it doesn&rsquo;t have power of Rvm, so your choice should depend on your situation. But let me talk about hero, he is waiting to be presented!</p>

<!-- more -->


<p>Installation is simple, because you already use capistrano, do you?</p>

<figure class='code'><figcaption><span>Gemfile </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;capistrano&#39;</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;rvm-capistrano&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now you should call the hero, to do that just place this line somewhere in the top of your capistrano&rsquo;s deploy file:</p>

<figure class='code'><figcaption><span>config/deploy.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rvm/capistrano&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will bring to you few things. First of all, it extends <code>base</code> to automatically <code>set :default_shell</code>. Also it adds these tasks:</p>

<ul>
<li><code>rvm:info</code> &ndash; show rvm info</li>
<li><code>rvm:list</code> &ndash; list rvm rubies</li>
<li><code>rvm:info_list</code> &ndash; show info and list rubies</li>
<li><code>rvm:install_rvm</code> &ndash; install RVM of the given choice to the server.</li>
<li><code>rvm:install_ruby</code> &ndash; install RVM ruby to the server, create gemset if needed</li>
<li><code>rvm:create_gemset</code> &ndash; create gemset</li>
</ul>


<p>If you forget about correct syntax you can always run <code>cap -T rvm</code> to list all tasks which gem provides. There are some additional tasks which you may include you can check them out in <a href="https://github.com/wayneeseguin/rvm-capistrano#modules">readme</a>.</p>

<p>With this gem you may, for example, update Rvm on each deploy and make sure that ruby is installed:</p>

<figure class='code'><figcaption><span>config/deploy.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s2">&quot;rvm/capistrano&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="n">set</span> <span class="ss">:rvm_ruby_string</span><span class="p">,</span> <span class="ss">:local</span>        <span class="c1"># use the same ruby as used locally for deployment</span>
</span><span class='line'>
</span><span class='line'><span class="n">before</span> <span class="s1">&#39;deploy&#39;</span><span class="p">,</span> <span class="s1">&#39;rvm:install_rvm&#39;</span>  <span class="c1"># install/update RVM</span>
</span><span class='line'><span class="n">before</span> <span class="s1">&#39;deploy&#39;</span><span class="p">,</span> <span class="s1">&#39;rvm:install_ruby&#39;</span> <span class="c1"># install Ruby and create gemset (both if missing)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Or set default ruby version and gemset:</p>

<figure class='code'><figcaption><span>config/deploy.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">set</span> <span class="ss">:rvm_ruby_string</span><span class="p">,</span> <span class="s1">&#39;2.0.0@gemset_name&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Or even restrict Rvm on some servers!</p>

<figure class='code'><figcaption><span>config/deploy.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">set</span> <span class="ss">:rvm_require_role</span><span class="p">,</span> <span class="ss">:rvm</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;rvm/capistrano/selector_mixed&quot;</span>
</span><span class='line'><span class="n">role</span> <span class="ss">:rvm</span><span class="p">,</span> <span class="s2">&quot;web1&quot;</span><span class="p">,</span> <span class="s2">&quot;web2&quot;</span>
</span><span class='line'><span class="n">role</span> <span class="ss">:app</span><span class="p">,</span> <span class="s2">&quot;web1&quot;</span><span class="p">,</span> <span class="s2">&quot;web2&quot;</span><span class="p">,</span> <span class="s2">&quot;web3&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Check out <a href="https://github.com/wayneeseguin/rvm-capistrano#readme">readme</a> for more details about this hero.</p>

<h3>capistrano-notifier</h3>

<p>If you use heroku then you receive email when deploy finishes. A like this feature and it is very cool that you can have the same functionality with capistrano. So, meet the second hero: <a href="https://github.com/cramerdev/capistrano-notifier">capistrano-notifier</a>.</p>

<p>The superpower of this hero is sending email with commits, which has been deployed, for example:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Obi-Wan Kenobi deployed
</span><span class='line'>Power branch
</span><span class='line'>stage to
</span><span class='line'>staging on
</span><span class='line'>02/24/2014 at
</span><span class='line'>02:37 PM MSK
</span><span class='line'>
</span><span class='line'>https://github.com/jedis/stage/compare/8fc335c...e3a999c
</span><span class='line'>8e8b39c The force is strong with this one (Obi-Wan Kenobi)
</span><span class='line'>b17e255 New lightsaber (Obi-Wan Kenobi)</span></code></pre></td></tr></table></div></figure>


<p>Looks pretty cool, huh? To install gem add it:</p>

<figure class='code'><figcaption><span>Gemfile </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;capistrano-notifier&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>After that you should add some settings to be able to send mails. Here is example for gmail:</p>

<figure class='code'><figcaption><span>config/deploy.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">set</span> <span class="ss">:notifier_mail_options</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>  <span class="ss">:method</span> <span class="o">=&gt;</span> <span class="ss">:smtp</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:from</span>   <span class="o">=&gt;</span> <span class="s1">&#39;capistrano@domain.com&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:to</span>     <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;john@doe.com&#39;</span><span class="p">,</span> <span class="s1">&#39;jane@doe.com&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:github</span> <span class="o">=&gt;</span> <span class="s1">&#39;MyCompany/project-name&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="ss">:smtp_settings</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">address</span><span class="p">:</span> <span class="s2">&quot;smtp.gmail.com&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">port</span><span class="p">:</span> <span class="mi">587</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">domain</span><span class="p">:</span> <span class="s2">&quot;gmail.com&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">authentication</span><span class="p">:</span> <span class="s2">&quot;plain&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">enable_starttls_auto</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span>
</span><span class='line'>    <span class="n">user_name</span><span class="p">:</span> <span class="no">MY_USERNAME</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">password</span><span class="p">:</span> <span class="no">MY_PASSWORD</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>After that each person, whose email has been provided in <code>:to</code> section will receive the email after deploy. Of course, you may need some time to set thins up properly, but afterwards this feature may be very handy for a lot of people.</p>

<h3>capistrano_deploy_lock</h3>

<p>Last, but not least hero is <a href="https://github.com/ndbroadbent/capistrano_deploy_lock">capistrano_deploy_lock</a>. I think you should know that nothing good will ever come out of two (and more) simultaneously deploys. This modest hero helps to fight with such evil.</p>

<p>Installation is simple:</p>

<figure class='code'><figcaption><span>Gemfile </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;capistrano_deploy_lock&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Call the hero:</p>

<figure class='code'><figcaption><span>config/deploy.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;capistrano/deploy_lock&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Make sure that all developers have this gem and config to protect your deploys. Now each deploy would be locked during deploy and would be unlocked afterwards. This protects each your deploy from simultaneously deploys of other people. Each person, who would try to deploy during current deploy would receive this message (or something like this):</p>

<figure class='code'><figcaption><span>Terminal </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>*** Deploy locked 3 minutes ago by <span class="s1">&#39;dark side&#39;</span>
</span><span class='line'>*** Message: Deploying master branch
</span><span class='line'>*** Expires in 12 minutes
</span></code></pre></td></tr></table></div></figure>


<p>This gem also helps in situations when your deploy fails, which gives you time to fix it (by default it is 15 minutes). This feature helped me few times. You can find more details in <a href="https://github.com/ndbroadbent/capistrano_deploy_lock#readme">readme</a></p>

<p>That is all for today, thank you for your patience.</p>

<p>P.S. All these gems have been tested with Rails 4 and they work.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Another Guide to Upgrade to Rails 4]]></title>
    <link href="http://bloginius.com/blog/2014/01/28/another-guide-to-upgrade-to-rails-4/"/>
    <updated>2014-01-28T15:53:10+04:00</updated>
    <id>http://bloginius.com/blog/2014/01/28/another-guide-to-upgrade-to-rails-4</id>
    <content type="html"><![CDATA[<p>Yep, this is another guide, which&rsquo;ll help you (i hope!) to upgrade your app to the Rails 4. Before start, please make sure that you are running latest Rails 3 release, i think it is 3.2.17 nowadays. Yes, i&rsquo;m sorry, Rails 2 guys, but this guide&rsquo;ll not help a lot, you have a lot of work to do, sorry! :)</p>

<!-- more -->


<p>What should you do next? You should upgrade <strong>all</strong> of your gems to their latest versions with support for rails 3, which can be a little bit hard, but good test coverage will help you a lot! If you don&rsquo;t have test coverage, then take a deep breath and… And create your test suit (i prefer Rspec for unit tests and Capybara, Capybara-webkit and Cucumber &ndash; for integration tests). You don&rsquo;t have to get 100% test coverage for your app, covering a main logic should be enough. Believe me, it&rsquo;s very important &ndash; at least you&rsquo;ll be sure that new libs and fresh code base&rsquo;ll not break your app.</p>

<p>Make sure that you have read <code>changelog</code> (this file also may be known as <code>history</code>) of each gem to get to know if gem&rsquo;d break anything. Good news is that upgrading of gems is not Rails 4 specific, so you can deploy your app when your gems&rsquo;d be up to date.</p>

<p>When your upgrade of gems is complete and all tests pass then you may push updated app to your test server and after testing push code to the production (it depends, of course, which workflow and how you use). Then you should wait for some time (day or more) to make sure that everything works great and upgrade of libs hasn&rsquo;t broken anything. Yes, tests may miss something, its okey, just write new tests and fix the problem to avoid regressions.</p>

<p>When you upgrade gems then you should make a note for yourself where you should specify which of the gems have new version for Rails 4 and which gems not work with Rails 4 (so you may remove them after upgrade or you need to fix them). Here is my example:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Rails 4 gems versions:
</span><span class='line'>rails_admin 0.6.0
</span><span class='line'>rails-i18n 4.0.1
</span><span class='line'>simple form 3.0
</span><span class='line'>paper_trail 3
</span><span class='line'>
</span><span class='line'>Remove in rails 4:
</span><span class='line'>activerecord-postgres-hstore
</span><span class='line'>sextant
</span><span class='line'>turbo-sprockets-rails3</span></code></pre></td></tr></table></div></figure>


<h2>Are gems ready for rails 4?</h2>

<p>Next step is checking out <a href="http://ready4rails4.net/">ready4rails4</a>, this site allows you to upload your Gemfile and check if your app is fully ready for Rails 4. Of course, you may not find your gems statuses or even gems. It&rsquo;s okay, you should check out repos of these gems (the easiest way is to find them via <a href="http://rubygems.org/">rubygems</a>) and then search a Readme, History/Changes or issues for any mentions of Rails 4. If you don&rsquo;t find anything, then you should just create an issue and ask about Rails 4 support. Actually, if gem is supported by an author, then it may have support for Rails 4. If repo is abandoned for a long time then you should probably search for forks or alternatives via <a href="https://www.ruby-toolbox.com/">ruby-toolbox</a> or create your own fork.</p>

<p>If you found any data about Rails 4&rsquo;s support for your gem/gems then you should definitely post your discover on <a href="http://ready4rails4.net/">ready4rails4</a>, it&rsquo;ll help other people a lot!</p>

<p>All these steps can take a long time, because you may have a lot of gems with unknown or even &ldquo;not ready&rdquo; statuses so you&rsquo;ll do a long research. But i&rsquo;m absolutely sure that you must do these preparations, because it&rsquo;ll really help you a lot during the actual rails 4 upgrade.</p>

<h2>Actual bump of rails</h2>

<p>So, you did all these steps and now you are ready to bump. Open the <code>Gemfile</code>:</p>

<figure class='code'><figcaption><span>Gemfile </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;4.0.2&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;sass-rails&#39;</span><span class="p">,</span>   <span class="s1">&#39;~&gt; 4.0.0&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;coffee-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 4.0.0&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;uglifier&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;= 1.3.0&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># add these gems to help with the transition:</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;protected_attributes&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;rails-observers&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;actionpack-page_caching&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;actionpack-action_caching&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;activerecord-session_store&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;actionpack-xml_parser&#39;</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;actionview-encoded_mail_to&#39;</span> <span class="c1"># protecting mail-to form bots</span>
</span></code></pre></td></tr></table></div></figure>


<p>Yep, you should remove assets group, bump rails, sass-rails, coffee-rails and uglifier. And you want to add gems above to have smooth transition. As you remember, i asked you to make a list of gems (which have their own version for Rails 4 and which should be removed). It&rsquo;s probably a good time to specify their version and remove unused gems according to your list. After that run <code>bundle install</code> and make sure that bundle&rsquo;ll evaluate and not throw errors.</p>

<p>Here i want to add my two cents about <a href="https://github.com/ryanb/cancan">cancan</a>. This gem is a great tool and i&rsquo;m sure that you may use it in your app. Well, here are good <a href="news:">news:</a> it&rsquo;s latest version (1.6.10) works if you keep attr_accessible (via &ldquo;protected_attributes&rdquo; gem). This also means that you shouldn&rsquo;t remove some options in your configs and you shouldn&rsquo;t start to use StrongParams (which is used by a lot of gems with Rails 4 support). So, you should keep these options in your configs:</p>

<figure class='code'><figcaption><span>config/application.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Enforce whitelist mode for mass assignment.</span>
</span><span class='line'><span class="c1"># This will create an empty whitelist of attributes available for mass-assignment for all models</span>
</span><span class='line'><span class="c1"># in your app. As such, your models will need to explicitly whitelist or blacklist accessible</span>
</span><span class='line'><span class="c1"># parameters by using an attr_accessible or attr_protected declaration.</span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">active_record</span><span class="o">.</span><span class="n">whitelist_attributes</span> <span class="o">=</span> <span class="kp">true</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>config/environments/* </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Raise exception on mass assignment protection for Active Record models</span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">active_record</span><span class="o">.</span><span class="n">mass_assignment_sanitizer</span> <span class="o">=</span> <span class="ss">:strict</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here <code>config/environments/*</code> means all files in that directory. That should be enough for cancan to work properly with Rails 4 until you&rsquo;d move to StrongParams completely (<a href="https://github.com/CanCanCommunity/cancancan">cancancan</a> supports Rails 4 completely, so i recommend to use it during StrongParams integration).</p>

<p>But i want to warn you about few things. First of all, almost all of the gems which support Rails 4 are not working with <code>attr_accessible</code>. It is bad for us, because you want to have a smooth transition (who doesn&rsquo;t?). So, you need to fork gems which generate mass-assigment errors and monkey-patch them so they&rsquo;d work with your app without StrongParams. This is not a bad solution, because if you have a big app with a lot of logic or you just use Cancan then integration of StrongParams&rsquo;ll be pain in the ass.</p>

<p>Of course, if you are not depending on the Cancan and/or your app is not so big then you might integrate StrongParams during Rails 4 upgrade and don&rsquo;t think a lot about forks and patches. But even then you may need to patch something (welcome to the  opensourse)!</p>

<p>I patched few gems so it would work with Rails 4, here is the list:</p>

<ol>
<li><a href="https://github.com/Loremaster/rails_admin">https://github.com/Loremaster/rails_admin</a> &ndash; it had problems with paper_trail 3 (which is for rails 4 only), so i patched it.</li>
<li><a href="https://github.com/Loremaster/simple-captcha">https://github.com/Loremaster/simple-captcha</a> &ndash; i added a patch for support <code>attr_accessible</code> only in Rails 4, use gem &lsquo;simple_captcha2&rsquo; if you are on StrongParams.</li>
<li><a href="https://github.com/Loremaster/impressionist">https://github.com/Loremaster/impressionist</a> &ndash; i added a patch for support <code>attr_accessible</code> only in Rails 4, use original gem &lsquo;impressionist&rsquo; if you are on StrongParams.</li>
</ol>


<p>Wow, so much work has been done! And I didn&rsquo;t even ask to launch your specs! I guess that now is a good time to run them! I suppose that you&rsquo;ll have a ton of deprecation messages and red tests. Check their errors, they may happen because of old gems in your Gemfile, or gems incapability to work with Rails 4 and attr_accessible. You also may want to check section below about deprecation messages.</p>

<p>Ok, now lets fix configs. Firstly you should edit <code>config/application.rb</code> and <code>config/environmens/*</code>, check out <a href="http://railsdiff.org/html/v3.2.16-v4.0.2.html">railsdiff</a> for that purpose. Keep in mind my notes about cancan!</p>

<p>When you&rsquo;ll finish with <code>config/</code> directory then you might want to apply edits to other files. Again, use <a href="http://railsdiff.org/html/v3.2.16-v4.0.2.html">railsdiff</a> for that. And don&rsquo;t forget to add <code>secret_key_base</code> in your secret_token.rb!</p>

<p>After all edits in configs you need to generate <code>bin</code> directory:</p>

<figure class='code'><figcaption><span>Terminal </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rake rails:update:bin
</span></code></pre></td></tr></table></div></figure>


<p>This will generate bin/ folder with bundle, rails and rake. You also might want to generate binstubs for spec and cucumber:</p>

<figure class='code'><figcaption><span>Terminal </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>bundle binstubs rspec-core
</span><span class='line'><span class="nv">$ </span>bundle binstubs cucumber
</span></code></pre></td></tr></table></div></figure>


<h2>Deprecations</h2>

<p>I will not mention all possible deprecation messages, but i want to tell you about important ones.</p>

<p>1) Dynamic methods. Here is short list (old method &ndash;> new method):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">find_all_by_</span><span class="o">.</span><span class="n">.</span><span class="o">.</span> <span class="o">-&gt;</span> <span class="n">where</span><span class="p">(</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</span><span class='line'><span class="n">find_last_by_</span><span class="o">.</span><span class="n">.</span><span class="o">.</span> <span class="o">-&gt;</span> <span class="n">where</span><span class="p">(</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'><span class="n">scoped_by_</span><span class="o">.</span><span class="n">.</span><span class="o">.</span> <span class="o">-&gt;</span> <span class="n">where</span><span class="p">(</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</span><span class='line'><span class="n">find_or_initialize_by_</span><span class="o">.</span><span class="n">.</span><span class="o">.</span> <span class="o">-&gt;</span> <span class="n">where</span><span class="p">(</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span><span class="o">.</span><span class="n">first_or_initialize</span>
</span><span class='line'><span class="n">find_or_create_by_</span><span class="o">.</span><span class="n">.</span><span class="o">.</span> <span class="o">-&gt;</span> <span class="n">find_or_create_by</span><span class="p">(</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span> <span class="ow">or</span> <span class="n">where</span><span class="p">(</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span><span class="o">.</span><span class="n">first_or_create</span>
</span><span class='line'><span class="n">find_or_create_by_</span><span class="o">.</span><span class="n">.</span><span class="o">.!</span> <span class="o">-&gt;</span> <span class="n">find_or_create_by!</span><span class="p">(</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span> <span class="ow">or</span> <span class="n">where</span><span class="p">(</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span><span class="o">.</span><span class="n">first_or_create!</span>
</span></code></pre></td></tr></table></div></figure>


<p>2) Match can&rsquo;t be used in routes anymore. So, instead of:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">match</span> <span class="s1">&#39;home/index&#39;</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span><span class="s1">&#39;home#index&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>You should use this one (if want to show page, of course):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">get</span> <span class="s1">&#39;home/index&#39;</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span><span class="s1">&#39;home#index&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can use <code>get</code>, <code>post</code>, <code>put</code>, <code>delete</code> or even <code>patch</code> depending on what you want to achieve.</p>

<p>3) Eager loading table(s) that are referenced in a string SQL snippet. That means that this will work great:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Post</span><span class="o">.</span><span class="n">includes</span><span class="p">(</span><span class="ss">:comments</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
</span></code></pre></td></tr></table></div></figure>


<p>But that:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Post</span><span class="o">.</span><span class="n">includes</span><span class="p">(</span><span class="ss">:comments</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;comments.title = &#39;foo&#39;&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Should be rewritten to use reference:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Post</span><span class="o">.</span><span class="n">includes</span><span class="p">(</span><span class="ss">:comments</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;comments.title = &#39;foo&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">references</span><span class="p">(</span><span class="ss">:comments</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is note why:</p>

<p><code>Currently, Active Record recognizes the table in the string, and knows to JOIN the comments table to the query, rather than loading comments in a separate query. However, doing this without writing a full-blown SQL parser is inherently flawed. Since we don't want to write an SQL parser, we are removing this functionality. From now on, you must explicitly tell Active Record when you are referencing a table from a string</code></p>

<p>4) New scopes. You should pass callable object to the scope (lambda, for example). So you need to change this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">scope</span> <span class="ss">:order_by_name</span><span class="p">,</span> <span class="n">order</span><span class="p">(</span><span class="s1">&#39;brands.name ASC&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>To that:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">scope</span> <span class="ss">:order_by_name</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="s1">&#39;brands.name ASC&#39;</span><span class="p">)</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>5) <code>.all</code> instead of <code>.scoped</code></p>

<p>In Rails 3 you could use <code>Model.scoped</code> to return Rails&rsquo;s relation of all Model&rsquo;s objects. In Rails 4 <code>.all</code> returns Rails Relation by default, so you should replace <code>.scoped</code> by <code>.all</code>.</p>

<h2>Deployment</h2>

<p>I have deployed my apps via capistrano 2.15.5 and i recommend you to use this version or higher. First of all, make sure that your Gemfile doesn&rsquo;t include gems which works with Rails 3 only, for example turbo-sprockets-rails3. In my case, i forgot to remove this gem so i had really weird error during first deploy with Rails 4.</p>

<p>Also, you should use <code>deploy:finalize_update</code> instead of <code>deploy:update_code</code>, i had an issue in Capistrano 2 with this thing, and this simple fix helped a lot.</p>

<p>And last note. You can get this error during the deploy:</p>

<figure class='code'><figcaption><span>Terminal </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>capistrano-2.15.5/lib/capistrano/recipes/deploy/assets.rb:68:in <span class="sb">`</span>block <span class="o">(</span>3 levels<span class="o">)</span> in load<span class="s1">&#39;:</span>
</span><span class='line'><span class="s1">More than one asset manifest file was found in &#39;</span>/srv/stage/shared/assets<span class="err">&#39;</span>.
</span><span class='line'>If you are upgrading a Rails 3 application to Rails 4, follow these instructions:
</span><span class='line'>http://github.com/capistrano/capistrano/wiki/Upgrading-to-Rails-4#asset-pipeline <span class="o">(</span>RuntimeError<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This error appears because Rails 3 has its own asset&rsquo;s manifest and Rails 4 has it&rsquo;s own. I just renamed assets directory and created the new one (empty). After that deployment was successful. Also you might just remove manifests and repeat your deploy but it&rsquo;ll make much harder to rollback to the Rails 3 so i don&rsquo;t recommend you to do that.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How Install Thinking Sphinx With PostgreSQL's Support on Mac OS X]]></title>
    <link href="http://bloginius.com/blog/2014/01/10/how-install-thinking-sphinx-with-postgresqls-support-on-mac-os-x/"/>
    <updated>2014-01-10T13:05:00+04:00</updated>
    <id>http://bloginius.com/blog/2014/01/10/how-install-thinking-sphinx-with-postgresqls-support-on-mac-os-x</id>
    <content type="html"><![CDATA[<p>Thinking Sphinx is a library, which allows you use Sphinx &ndash; full text search server. But setup can be tricky, if you use PostgreSQL. In this post I will show you you how setup it.</p>

<p>First of all, make sure that you have installed Mysql. The best way to install it is just use homebrew:</p>

<figure class='code'><figcaption><span>Terminal </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>brew install <span class="nv">mysql</span>
</span><span class='line'><span class="o">==</span>&gt; Downloading https://downloads.sf.net/project/machomebrew/Bottles/mysql-5.6.15.mavericks.bottle.tar.gz
</span><span class='line'><span class="c">######################################################################## 100.0%</span>
</span><span class='line'><span class="o">==</span>&gt; Pouring mysql-5.6.15.mavericks.bottle.tar.gz
</span><span class='line'><span class="o">==</span>&gt; Caveats
</span><span class='line'>A <span class="s2">&quot;/etc/my.cnf&quot;</span> from another install may interfere with a Homebrew-built
</span><span class='line'>server starting up correctly.
</span><span class='line'>
</span><span class='line'>To connect:
</span><span class='line'>    mysql -uroot
</span><span class='line'>
</span><span class='line'>To have launchd start mysql at login:
</span><span class='line'>    ln -sfv /usr/local/opt/mysql/*.plist ~/Library/LaunchAgents
</span><span class='line'>Then to load mysql now:
</span><span class='line'>    launchctl load ~/Library/LaunchAgents/homebrew.mxcl.mysql.plist
</span><span class='line'>Or, <span class="k">if </span>you don<span class="err">&#39;</span>t want/need launchctl, you can just run:
</span><span class='line'>    mysql.server start
</span></code></pre></td></tr></table></div></figure>


<p>I recommend you to copy and past commands from homebrew&rsquo;s output after installation.</p>

<p>If you don&rsquo;t want to use homebrew (but i strongly recommend to <strong>use</strong> homebrew), then you should install x64 MySQL server from <a href="http://dev.mysql.com/downloads/mysql/">official site</a>. Make sure to use x64, you don&rsquo;t want to get any weird errors (I guess that you use at least OS X 10.6).</p>

<p>Now you should install Sphinx. And it&rsquo;s a tricky part. If you would install it without any flag or with just mysql support, you would get such weird errors:</p>

<figure class='code'><figcaption><span>Terminal </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rake ts:index
</span><span class='line'>Generating configuration to /Users/serj/Projects/gearup/config/development.sphinx.conf
</span><span class='line'>Sphinx 2.1.3-dev <span class="o">(</span>r4319<span class="o">)</span>
</span><span class='line'>Copyright <span class="o">(</span>c<span class="o">)</span> 2001-2013, Andrew Aksyonoff
</span><span class='line'>Copyright <span class="o">(</span>c<span class="o">)</span> 2008-2013, Sphinx Technologies Inc <span class="o">(</span>http://sphinxsearch.com<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>using config file <span class="s1">&#39;/Users/serj/Projects/gearup/config/development.sphinx.conf&#39;</span>...
</span><span class='line'>indexing index <span class="s1">&#39;service_core&#39;</span>...
</span><span class='line'>ERROR: <span class="nb">source</span> <span class="s1">&#39;service_core_0&#39;</span>: unknown <span class="nb">type</span> <span class="s1">&#39;pgsql&#39;</span>; skipping.
</span><span class='line'>ERROR: index <span class="s1">&#39;service_core&#39;</span>: failed to configure some of the sources, will not index.
</span><span class='line'>total 0 reads, 0.000 sec, 0.0 kb/call avg, 0.0 msec/call avg
</span><span class='line'>total 0 writes, 0.000 sec, 0.0 kb/call avg, 0.0 msec/call avg
</span></code></pre></td></tr></table></div></figure>


<p>To avoid them you should instal sphinx with mysql <strong>and</strong> postgres support:</p>

<figure class='code'><figcaption><span>Terminal </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>brew install sphinx --mysql --pgsql
</span><span class='line'><span class="o">==</span>&gt; Downloading http://sphinxsearch.com/files/sphinx-2.1.3-release.tar.gz
</span><span class='line'>Already downloaded: /Library/Caches/Homebrew/sphinx-2.1.3.tar.gz
</span><span class='line'><span class="o">==</span>&gt; Downloading http://snowball.tartarus.org/dist/libstemmer_c.tgz
</span><span class='line'>Already downloaded: /Library/Caches/Homebrew/sphinx--stemmer-c.tgz
</span><span class='line'><span class="o">==</span>&gt; ./configure --prefix<span class="o">=</span>/usr/local/Cellar/sphinx/2.1.3 --localstatedir<span class="o">=</span>/usr/local/var --with-libstemmer --with-mysql --with-pgsql
</span><span class='line'><span class="o">==</span>&gt; make <span class="nv">install</span>
</span><span class='line'><span class="o">==</span>&gt; Caveats
</span><span class='line'>Sphinx has been compiled with libstemmer support.
</span><span class='line'>
</span><span class='line'>Sphinx depends on either MySQL or PostreSQL as a datasource.
</span><span class='line'>
</span><span class='line'>You can install these with Homebrew with:
</span><span class='line'>  brew install mysql
</span><span class='line'>    For MySQL server.
</span><span class='line'>
</span><span class='line'>  brew install mysql-connector-c
</span><span class='line'>    For MySQL client libraries only.
</span><span class='line'>
</span><span class='line'>  brew install postgresql
</span><span class='line'>    For PostgreSQL server.
</span><span class='line'>
</span><span class='line'>We don<span class="s1">&#39;t install these for you when you install this formula, as</span>
</span><span class='line'><span class="s1">we don&#39;</span>t know which datasource you intend to use.
</span><span class='line'><span class="o">==</span>&gt; Summary
</span><span class='line'>🍺  /usr/local/Cellar/sphinx/2.1.3: 16 files, 18M, built in 17 seconds
</span></code></pre></td></tr></table></div></figure>


<p>After that you can install Thinking Sphinx:</p>

<figure class='code'><figcaption><span>Gemfile </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;mysql2&#39;</span><span class="p">,</span>          <span class="s1">&#39;0.3.13&#39;</span><span class="p">,</span> <span class="ss">:platform</span> <span class="o">=&gt;</span> <span class="ss">:ruby</span>
</span><span class='line'><span class="n">gem</span> <span class="s1">&#39;thinking-sphinx&#39;</span><span class="p">,</span> <span class="s1">&#39;3.1.0&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And everything should be ok!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How Integrate ActsAsTaggableOn With Jquery Token Input (With Rails 3)]]></title>
    <link href="http://bloginius.com/blog/2013/12/31/how-integrate-acts-as-taggable-on-with-jquery-token-input-with-rails-3/"/>
    <updated>2013-12-31T16:53:11+04:00</updated>
    <id>http://bloginius.com/blog/2013/12/31/how-integrate-acts-as-taggable-on-with-jquery-token-input-with-rails-3</id>
    <content type="html"><![CDATA[<p>Have you ever met problems with integrating the <a href="http://loopj.com/jquery-tokeninput/">Jquery Token Input</a> and the <a href="https://github.com/mbleigh/acts-as-taggable-on">acts_as_taggable_on</a>? Or are you gonna to implement these things together? Hold on! This article&rsquo;ll help you: I&rsquo;ll show you step by step how to do that with Rails 3.2.</p>

<!-- more -->


<h2>Acts as taggable on</h2>

<p>First of all, you should, of course, install acts_as_taggable_on. Add this in your gemfile:</p>

<figure class='code'><figcaption><span>Gemfile </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;acts-as-taggable-on&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And run these commands to install it:</p>

<figure class='code'><figcaption><span>Terminal </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>bundle
</span><span class='line'><span class="nv">$ </span>rails g acts_as_taggable_on:migration
</span><span class='line'><span class="nv">$ </span>rake db:migrate
</span></code></pre></td></tr></table></div></figure>


<p>This will install gem, create and run it&rsquo;s migration to set your database properly. Next, you should attach tags to any existing model of your choice. In my case its the model Movie:</p>

<figure class='code'><figcaption><span>app/models/movie.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Movie</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">acts_as_taggable</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:tag_list</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Interesting thing is that the <code>acts_as_taggable</code> is just an alias for <code>acts_as_taggable_on :tags</code>. So you can really use any other name for your tags of your own choice. Also make sure that you added <code>tag_list</code> in <code>attr_accessible</code> section to be able to save tags.</p>

<p>Not it&rsquo;s time to create and then show tags. To do that you should add this simple code inside of your view with the form:</p>

<figure class='code'><figcaption><span>app/views/movies/_form.html.erb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="x">&lt;div class=&quot;field&quot;&gt;</span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:tag_list</span><span class="p">,</span> <span class="s2">&quot;Your tags (separated by commas)&quot;</span> <span class="cp">%&gt;</span><span class="x">&lt;br/&gt;</span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:tag_list</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>To show tags you can use method <code>tag_list</code> which returns array of tags for a current object:</p>

<figure class='code'><figcaption><span>app/views/movies/show.html.erb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="x">&lt;p&gt;</span>
</span><span class='line'><span class="x">  &lt;b&gt;Name:&lt;/b&gt;</span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%=</span> <span class="vi">@movie</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">  &lt;br&gt;</span>
</span><span class='line'><span class="x">  &lt;b&gt;Tags:&lt;/b&gt;</span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">raw</span> <span class="vi">@movie</span><span class="o">.</span><span class="n">tag_list</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">&lt;/p&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>That should be enough to be able manage your tags with acts_as_taggable_on. Now it&rsquo;s time to implement Jquery token input.</p>

<h2>Jquery token input</h2>

<p>To load <a href="https://github.com/loopj/jquery-tokeninput">jquery-token-input</a> in your app you should add it&rsquo;s js and css files in <code>vendor/assets</code> and after that include these files inside of your js and css manifests. For example:</p>

<figure class='code'><figcaption><span>assets/stylesheets/application.css </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="o">*=</span> <span class="nt">require</span> <span class="nt">token-input-mac</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>assets/javascripts/application.js </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">//= require jquery.tokeninput</span>
</span></code></pre></td></tr></table></div></figure>


<p>Please, note, that you css file may have another name (there are few themes available out the box) and it&rsquo;s really okay.</p>

<p>Now I would like to show to you my final coffee&rsquo;s code, which will do the job for my tags:</p>

<figure class='code'><figcaption><span>assets/javascripts/movies.js.coffee </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nx">jQuery</span> <span class="nf">-&gt;</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s">&#39;#movie_tag_list_tokens&#39;</span><span class="p">).</span><span class="nx">tokenInput</span> <span class="s">&#39;/movies/tags.json&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nv">theme: </span><span class="s">&#39;mac&#39;</span>
</span><span class='line'>    <span class="nv">minChars: </span><span class="mi">2</span>
</span><span class='line'>    <span class="nv">allowCustomEntry: </span><span class="kc">true</span>
</span><span class='line'>    <span class="nv">preventDuplicates: </span><span class="kc">true</span>
</span><span class='line'>    <span class="nv">prePopulate: </span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;#movie_tag_list_tokens&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="s">&#39;load&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This code will grab and show new tags via ajax from the URL <code>/movies/tags.json</code>, basing on user input. But really, a tag can&rsquo;t consist of a single symbol, so I set minimum at 2 symbols to prohibit such bad behavior. Jquery token input will validate it for us.</p>

<p>To be able to create a new tag you should use <code>allowCustomEntry</code>. Also, a movie can already have tags, so i upload data from the div using data-load tag (you can easily implement it since Rails 3.1) and pass it to the <code>prePopulate</code> method. If you still not using Rails 3.1 then you can use instead of that gem <a href="https://github.com/gazay/gon">gon</a>, which I really love. And please, please upgrade Rails to the newer version!</p>

<p>Now it&rsquo;s time to add the method in controller, which will return all founded movies tags (so app will return data on <code>/movies/tags.json</code> call). First of all, add route with <code>tag</code> method:</p>

<figure class='code'><figcaption><span>config/routes.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">resources</span> <span class="ss">:movies</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">collection</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">get</span> <span class="ss">:tags</span><span class="p">,</span> <span class="ss">as</span><span class="p">:</span> <span class="ss">:tags</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now I should add an actual method to the controller:</p>

<figure class='code'><figcaption><span>app/controllers/movies_controller.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">tags</span>
</span><span class='line'>  <span class="n">tags</span> <span class="o">=</span> <span class="no">Movie</span><span class="o">.</span><span class="n">all_tag_counts</span><span class="o">.</span><span class="n">by_tag_name</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:q</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">token_input_tags</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class='line'>    <span class="nb">format</span><span class="o">.</span><span class="n">json</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">json</span><span class="p">:</span> <span class="n">tags</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This code will do the job (it returns all movies tags). Note, that I use some tricks on the code above. I want to find tags of specific model (Movie), it makes sense, because I may have many tags for different models, and I want to separate model&rsquo;s tags from each other. That is why I use <code>all_tag_counts</code> which returns relation of tags (representing as array) for a <code>Movie</code>.</p>

<p>When the app gets all necessary tags via <code>all_tag_counts</code> then it should filter them to find tags which’ll match user&rsquo;s input. For that purpose I use the scope <code>by_tag_name</code> which find data in received ActsAsTaggableOn’s relation. And finally, you should transform founded tags in the format, which Jquery token input will understand. If you would look up in the <a href="http://loopj.com/jquery-tokeninput/">docs</a> then you would see that js expects data in the very specific format:</p>

<figure class='code'><figcaption><span>Json tags </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">[</span>
</span><span class='line'>  <span class="p">{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;856&quot;</span><span class="p">,</span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;House&quot;</span><span class="p">},</span>
</span><span class='line'>  <span class="p">{</span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="s2">&quot;1035&quot;</span><span class="p">,</span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;Desperate Housewives&quot;</span><span class="p">}</span>
</span><span class='line'><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>But when <code>by_tag_name</code> scope has fired then I got such relation (as you remember):</p>

<figure class='code'><figcaption><span>by_tag_name output </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">[</span> <span class="c1">#&lt;ActsAsTaggableOn::Tag id: 1, name: &quot;Piter Pan&quot;&gt;, #&lt;ActsAsTaggableOn::Tag id: 2, name: &quot;Superman&quot;&gt;, #&lt;ActsAsTaggableOn::Tag id: 3, name: &quot;Piter Parker&quot;&gt; ]</span>
</span></code></pre></td></tr></table></div></figure>


<p>So I should transform my data for Jquery Token Input and method <code>token_input_tags</code> does it.</p>

<p>To implement <code>by_tag_name</code> and <code>token_input_tags</code> you should define the module in your <code>lib/</code> directory and after that include your module in the ActsAsTaggableOn, because the <code>all_tag_counts</code> returns ActsAsTaggableOn’s relation.</p>

<p>Here is my module:</p>

<figure class='code'><figcaption><span>lib/extended/tag_extend.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">TagExtend</span>
</span><span class='line'>  <span class="kp">extend</span> <span class="ss">ActiveSupport</span><span class="p">:</span><span class="ss">:Concern</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">included</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">scope</span> <span class="ss">:by_tag_name</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="nb">name</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="s2">&quot;name like ?&quot;</span><span class="p">,</span> <span class="s2">&quot;%</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">token_input_tags</span>
</span><span class='line'>        <span class="n">scoped</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">t</span><span class="o">|</span> <span class="p">{</span><span class="nb">id</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">name</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">name</span> <span class="p">}}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here I define my scope and method with some help of the ActiveSupport (thank you, guys!). You may be surprised that I put in the id name of a tag, but it&rsquo;s the only workaround which works for ActsAsTaggableOn (otherwise created tag will contain id instead of the name).</p>

<p>Now let&rsquo;s tell Rails to find my libs. In config/application.rb add:</p>

<figure class='code'><figcaption><span>config/application.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">autoload_paths</span> <span class="o">+=</span> <span class="no">Dir</span><span class="o">[</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">config</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="s2">/lib/**/&quot;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>And finally, lets include our module in ActsAsTaggableOn. Create in initializers file <code>acts_as_taggable_on.rb</code> and add in that file:</p>

<figure class='code'><figcaption><span>config/initializers/acts_as_taggable_on.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">ActsAsTaggableOn</span><span class="p">:</span><span class="ss">:Tag</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:include</span><span class="p">,</span> <span class="ss">ActsAsJqueryTokenRails3</span><span class="p">:</span><span class="ss">:TagExtend</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>ActsAsTaggableOn is now having my scope and the defined method! Awesome!</p>

<p>But I didn&rsquo;t finish. When you create few tags, save your model and then try to edit your model then you expect to see your existing tags. So, lets implement it.</p>

<h2>Prepopulating tags</h2>

<p>As you remember, I has already defined such line of the code in my coffee&rsquo;s file:</p>

<figure class='code'><figcaption><span>assets/javascripts/movies.js.coffee </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">prePopulate: </span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;#movie_tag_list_tokens&#39;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="s">&#39;load&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>To load actual movies tags I should add my data tag in the movie&rsquo;s edit form and then fill it with actual data. Here is updated form:</p>

<figure class='code'><figcaption><span>app/views/movies/_form.html.erb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='erb'><span class='line'><span class="x">&lt;div class=&quot;field&quot;&gt;</span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:tag_list_tokens</span><span class="p">,</span> <span class="s2">&quot;Your tags (separated by commas)&quot;</span> <span class="cp">%&gt;</span><span class="x">&lt;br/&gt;</span>
</span><span class='line'><span class="x">  </span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:tag_list_tokens</span><span class="p">,</span> <span class="ss">data</span><span class="p">:</span> <span class="p">{</span><span class="nb">load</span><span class="p">:</span> <span class="vi">@movie_tags</span><span class="p">}</span> <span class="cp">%&gt;</span><span class="x"></span>
</span><span class='line'><span class="x">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>I didn&rsquo;t just add data but also I changed the name of the field. It&rsquo;s because when you create new tags then you get them in very specific format:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>"old_tag1,old_tag2,'new_tag1','new_tag2'"</span></code></pre></td></tr></table></div></figure>


<p>As you can see, new tags are wrapped in single quotes. App shouldn&rsquo;t save these quotes, because user hasn&rsquo;t printed them. To do that I define a virtual attribute in my model and override setter to save actual tags without quotes:</p>

<figure class='code'><figcaption><span>app/models/movie.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Movie</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>  <span class="n">acts_as_taggable</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">attr_reader</span> <span class="ss">:tag_list_tokens</span>
</span><span class='line'>  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:tag_list_tokens</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">tag_list_tokens</span><span class="o">=</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">tag_list</span> <span class="o">=</span> <span class="n">tokens</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Please notice, that now you can and should remove <code>tag_list</code> from attr_accessible.</p>

<p>All right, it&rsquo;s time to populate our movies tags! For that purpose in movies_controller i added before_filter to call a new method to collect existing tags:</p>

<figure class='code'><figcaption><span>app/controllers/movies_controller.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">before_filter</span> <span class="ss">:find_tags</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#...</span>
</span><span class='line'>
</span><span class='line'><span class="kp">private</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">find_tags</span>
</span><span class='line'>  <span class="vi">@movie_tags</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">].</span><span class="n">present?</span> <span class="p">?</span> <span class="no">Movie</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">token_input_tags</span> <span class="p">:</span> <span class="o">[]</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now our app works, you can create new tags, add existing one, search them via ajax and even delete them. Thanks for your patience!</p>

<p>P.S. You can find working demo, it uses all these features in <a href="https://github.com/Loremaster/acts-as-jquery-token-rails3">my github&rsquo;s repo</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How Upgrade Devise 2 to 3.2]]></title>
    <link href="http://bloginius.com/blog/2013/12/26/how-upgrade-devise-2-dot-x-to-3-dot-2-x/"/>
    <updated>2013-12-26T15:37:53+04:00</updated>
    <id>http://bloginius.com/blog/2013/12/26/how-upgrade-devise-2-dot-x-to-3-dot-2-x</id>
    <content type="html"><![CDATA[<p><a href="https://github.com/plataformatec/devise">Devise</a> is a great gem! It really helps you, taking all authentication jobs away from you. However, upgrading Devise up to version 3.x can be a little bit tricky. In this post I&rsquo;ll show you how to do that.</p>

<p>First of all, update your gem via <code>bundle update</code> OR specify version in your Gemfile:</p>

<figure class='code'><figcaption><span>Gemfile </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s2">&quot;devise&quot;</span><span class="p">,</span> <span class="s2">&quot;~&gt; 3.2.2&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And run <code>bundle install</code>.</p>

<p>Since devise 3.1 platformatec <a href="http://blog.plataformatec.com.br/2013/08/devise-3-1-now-with-more-secure-defaults/">announced</a> few security improvements. One of them is <code>secret_key</code>. To add it open devise config and add:</p>

<figure class='code'><figcaption><span>config/initializers/devise.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># The secret key used by Devise. Devise uses this key to generate</span>
</span><span class='line'><span class="c1"># random tokens. Changing this key will render invalid all existing</span>
</span><span class='line'><span class="c1"># confirmation, reset password and unlock tokens in the database.</span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="s1">&#39;2710f15f11771d6692a3015d7e3dba2cb05539c1f72i6u345df5433hg535kj5x56v6er56if2566c63c2ad670d6859e536b40d87e6543b115609f0464bdd99502abbe241c4&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Of course, you should use your own secret key, so change my example to be more secure.</p>

<p>If you have ever generated devise&rsquo;s views, then you should change it&rsquo;s mailers to use <code>@token</code> instead of <code>@resource.*_token</code>:</p>

<figure class='code'><figcaption><span>views/devise/mailer/confirmation_instructions.html.haml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'># ...
</span><span class='line'><span class="p">=</span> <span class="n">link_to</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;devise.mailer.confirmation_instructions.submit&#39;</span><span class="p">),</span> <span class="n">confirmation_url</span><span class="p">(</span><span class="vi">@resource</span><span class="p">,</span> <span class="n">confirmation_token</span><span class="p">:</span> <span class="vi">@token</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>views/devise/mailer/reset_password_instructions.html.haml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'># ...
</span><span class='line'><span class="p">=</span> <span class="n">link_to</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;devise.mailer.reset_password_instructions.reset_link&#39;</span><span class="p">),</span> <span class="n">edit_password_url</span><span class="p">(</span><span class="vi">@resource</span><span class="p">,</span> <span class="n">reset_password_token</span><span class="p">:</span> <span class="vi">@token</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>views/devise/mailer/unlock_instructions.html.haml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='haml'><span class='line'># ...
</span><span class='line'><span class="p">=</span> <span class="n">link_to</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;devise.mailer.unlock_instructions.unlock_link&#39;</span><span class="p">),</span> <span class="n">unlock_url</span><span class="p">(</span><span class="vi">@resource</span><span class="p">,</span> <span class="n">unlock_token</span><span class="p">:</span> <span class="vi">@token</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>After that everything should works. But take a look into your terminal: you may have deprecation errors, which you should fix!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How Set Up Sublime Text 2 as Your Default Git Editor]]></title>
    <link href="http://bloginius.com/blog/2013/12/25/how-set-up-sublime-text-2-as-default-git-editor/"/>
    <updated>2013-12-25T12:42:58+04:00</updated>
    <id>http://bloginius.com/blog/2013/12/25/how-set-up-sublime-text-2-as-default-git-editor</id>
    <content type="html"><![CDATA[<p>If you love Sublime Text 2 as I do then you probably would like to change default git editor (which is Vim nowadays). I suppose that you have installed Sublime text.</p>

<p>First of all, you should install <code>subl</code> shortcut. To do that open your shell and print (if you already have <code>~/bin</code> directory, then just use the last line of my code):</p>

<figure class='code'><figcaption><span>Terminal </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">cd</span> ~
</span><span class='line'><span class="nv">$ </span>mkdir bin
</span><span class='line'><span class="nv">$ </span>ln -s <span class="s2">&quot;/Applications/Sublime Text 2.app/Contents/SharedSupport/bin/subl&quot;</span> ~/bin/subl
</span></code></pre></td></tr></table></div></figure>


<p>Now restart your shell and try that:</p>

<figure class='code'><figcaption><span>Terminal </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>subl -h
</span><span class='line'>Sublime Text 2 Build 2221
</span><span class='line'>
</span><span class='line'>Usage: subl <span class="o">[</span>arguments<span class="o">]</span> <span class="o">[</span>files<span class="o">]</span>         edit the given files
</span><span class='line'>   or: subl <span class="o">[</span>arguments<span class="o">]</span> <span class="o">[</span>directories<span class="o">]</span>   open the given directories
</span><span class='line'>   or: subl <span class="o">[</span>arguments<span class="o">]</span> -               edit stdin
</span><span class='line'>
</span><span class='line'>Arguments:
</span><span class='line'>  --project &lt;project&gt;: Load the given project
</span><span class='line'>  --command &lt;<span class="nb">command</span>&gt;: Run the given <span class="nb">command</span>
</span><span class='line'>  -n or --new-window:  Open a new window
</span><span class='line'>  -a or --add:         Add folders to the current window
</span><span class='line'>  -w or --wait:        Wait <span class="k">for </span>the files to be closed before returning
</span><span class='line'>  -b or --background:  Don<span class="err">&#39;</span>t activate the application
</span><span class='line'>  -s or --stay:        Keep the application activated after closing the file
</span><span class='line'>  -h or --help:        Show <span class="nb">help</span> <span class="o">(</span>this message<span class="o">)</span> and <span class="nb">exit</span>
</span><span class='line'>  -v or --version:     Show version and <span class="nb">exit</span>
</span><span class='line'>
</span><span class='line'>--wait is implied <span class="k">if </span>reading from stdin. Use --stay to not switch back
</span><span class='line'>to the terminal when a file is closed <span class="o">(</span>only relevant <span class="k">if </span>waiting <span class="k">for </span>a file<span class="o">)</span>.
</span><span class='line'>
</span><span class='line'>Filenames may be given a :line or :line:column suffix to open at a specific
</span><span class='line'>location.
</span></code></pre></td></tr></table></div></figure>


<p>If you have the same output, then everything works great. Otherwise you should add <code>~/bin</code> to your $PATH. To do that open your <code>~.bash_profile</code> and append these lines to the end of the file:</p>

<figure class='code'><figcaption><span>.bash_profile </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PATH</span>:~/bin
</span><span class='line'><span class="nb">export </span>PATH
</span></code></pre></td></tr></table></div></figure>


<p>And I think that you should restart your shell again.</p>

<p>Finally, to set up sublime as default editor just print in your shell that:</p>

<figure class='code'><figcaption><span>Terminal </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>git config --global core.editor <span class="s2">&quot;subl -n -w&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And that is all!</p>
]]></content>
  </entry>
  
</feed>
